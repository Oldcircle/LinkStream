var ne=Object.defineProperty;var v=n=>{throw TypeError(n)};var re=(n,e,t)=>e in n?ne(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var x=(n,e,t)=>re(n,typeof e!="symbol"?e+"":e,t),K=(n,e,t)=>e.has(n)||v("Cannot "+t);var c=(n,e,t)=>(K(n,e,"read from private field"),t?t.call(n):e.get(n)),b=(n,e,t)=>e.has(n)?v("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(n):e.set(n,t),l=(n,e,t,r)=>(K(n,e,"write to private field"),r?r.call(n,t):e.set(n,t),t),D=(n,e,t)=>(K(n,e,"access private method"),t);import{b as ie,c as ae,R as f,A as se,P as F,W as Y}from"./stream-CeehbguB.js";function Z(n){return typeof n=="object"&&n!==null&&"then"in n}function Q(n,e){for(;;){const{done:t,value:r}=n.next(e);if(t)return r;if(Z(r))return r.then(i=>Q(n,{resolved:i}),i=>Q(n,{error:i}));e=r}}function $(n,e){function t(...r){const i=n.call(this,function*(a){if(Z(a)){const s=yield a;if("resolved"in s)return s.resolved;throw s.error}return a},...r);return Q(i,void 0)}return t}function ce(n){return(e,t)=>{if("buffer"in t){const r=n(e,t);return t.buffer.set(r,t.index),r.length}else return n(e,t)}}function ue(n,e){return(t,r)=>{if("buffer"in r)return r.index??(r.index=0),e(t,r),n;{const i=new Uint8Array(n);return e(t,{buffer:i,index:0,littleEndian:r.littleEndian}),i}}}function de(n,e,t,r,i){const a={size:n,type:e,serialize:e==="default"?ce(t):ue(n,t),deserialize:$(r),omitInit:i==null?void 0:i.omitInit};return i!=null&&i.init&&(a.init=i.init),a}const w=de,R=new Uint8Array(0);function oe(n,e){return typeof n=="number"?e?n===0?w(0,"byob",()=>{},function*(){return e.convert(R)}):w(n,"byob",(t,{buffer:r,index:i})=>{r.set(t.slice(0,n),i)},function*(t,r){const i=yield*t(r.readExactly(n));return e.convert(i)},{init(t){return e.back(t)}}):n===0?w(0,"byob",()=>{},function*(){return R}):w(n,"byob",(t,{buffer:r,index:i})=>{r.set(t.slice(0,n),i)},function*(t,r){return r.readExactly(n)}):(typeof n=="object"||typeof n=="function")&&"serialize"in n?e?w(n.size,"default",(t,{littleEndian:r})=>{if(n.type==="default"){const i=n.serialize(t.length,{littleEndian:r}),a=new Uint8Array(i.length+t.length);return a.set(i,0),a.set(t,i.length),a}else{const i=new Uint8Array(n.size+t.length);return n.serialize(t.length,{buffer:i,index:0,littleEndian:r}),i.set(t,n.size),i}},function*(t,r,i){const a=yield*t(n.deserialize(r,i)),s=yield*t(r.readExactly(a));return e.convert(s)},{init(t){return e.back(t)}}):w(n.size,"default",(t,{littleEndian:r})=>{if(n.type==="default"){const i=n.serialize(t.length,{littleEndian:r}),a=new Uint8Array(i.length+t.length);return a.set(i,0),a.set(t,i.length),a}else{const i=new Uint8Array(n.size+t.length);return n.serialize(t.length,{buffer:i,index:0,littleEndian:r}),i.set(t,n.size),i}},function*(t,r,i){const a=yield*t(n.deserialize(r,i));return yield*t(r.readExactly(a))}):typeof n=="string"?e?w(0,"default",t=>t,function*(t,r,{dependencies:i}){const a=i[n];return a===0?R:r.readExactly(a)},{init(t,r){const i=e.back(t);return r[n]=i.length,i}}):w(0,"default",t=>t,function*(t,r,{dependencies:i}){const a=i[n];return a===0?R:r.readExactly(a)},{init(t,r){r[n]=t.length}}):e?w(0,"default",t=>t,function*(t,r,{dependencies:i}){const a=i[n.field],s=n.convert(a);return s===0?R:r.readExactly(s)},{init(t,r){const i=e.back(t);return r[n.field]=n.back(i.length),i}}):w(0,"default",t=>t,function*(t,r,{dependencies:i}){const a=i[n.field],s=n.convert(a);return s===0?R:r.readExactly(s)},{init(t,r){r[n.field]=n.back(t.length)}})}const le=oe;class O extends Error{constructor(){super("ExactReadable ended")}}class g extends Error{constructor(e){super(e)}}class pe extends g{constructor(){super("The underlying readable was ended before the struct was fully deserialized")}}class ee extends g{constructor(){super("The underlying readable doesn't contain any more struct")}}function he(n,e){const t=Object.entries(n);let r=0,i=!0;for(const[,u]of t)r+=u.size,i&&u.type!=="byob"&&(i=!1);const a=e.littleEndian,s=e.extra?Object.getOwnPropertyDescriptors(e.extra):void 0;return{littleEndian:a,fields:n,extra:e.extra,type:i?"byob":"default",size:r,serialize(u,o){var k;const d={...u};for(const[y,p]of t)if(y in d&&"init"in p){const j=(k=p.init)==null?void 0:k.call(p,d[y],d);j!==void 0&&(d[y]=j)}const h=new Array(t.length),A=new Array(t.length);{const y={littleEndian:a};for(const[p,[j,J]]of t.entries())J.type==="byob"?h[p]=J.size:(A[p]=J.serialize(d[j],y),h[p]=A[p].length)}const B=h.reduce((y,p)=>y+p,0);let N,q,T;if(o instanceof Uint8Array){if(o.length<B)throw new Error("Buffer too small");N=!0,q=o,T=0}else if(typeof o=="object"&&"buffer"in o){if(N=!0,q=o.buffer,T=o.index??0,q.length-T<B)throw new Error("Buffer too small")}else N=!1,q=new Uint8Array(B),T=0;const G={buffer:q,index:T,littleEndian:a};for(const[y,[p,j]]of t.entries())A[y]?q.set(A[y],G.index):j.serialize(d[p],G),G.index+=h[y];return N?B:q},deserialize:$(function*(u,o){const d=o.position,h={},A={dependencies:h,littleEndian:a};try{for(const[B,N]of t)h[B]=yield*u(N.deserialize(o,A))}catch(B){throw B instanceof O?o.position===d?new ee:new pe:B}return s&&Object.defineProperties(h,s),e.postDeserialize?e.postDeserialize.call(h,h):h})}}function Le(n,e,t){return he(Object.assign({},n.fields,e),{littleEndian:(t==null?void 0:t.littleEndian)??n.littleEndian,extra:n.extra,postDeserialize:t==null?void 0:t.postDeserialize})}function ye(n,e,t){return t?n[e]|n[e+1]<<8|n[e+2]<<16|n[e+3]<<24:n[e]<<24|n[e+1]<<16|n[e+2]<<8|n[e+3]}function we(n,e,t,r){r?(n[e]=t,n[e+1]=t>>8,n[e+2]=t>>16,n[e+3]=t>>24):(n[e]=t>>24,n[e+1]=t>>16,n[e+2]=t>>8,n[e+3]=t)}function Me(n,e){return n[e]<<8|n[e+1]}function me(n,e,t){return t?n[e]|n[e+1]<<8:n[e+1]|n[e]<<8}function xe(n,e,t,r){r?(n[e]=t,n[e+1]=t>>8):(n[e]=t>>8,n[e+1]=t)}function _e(n,e){return BigInt(n[e])|BigInt(n[e+1])<<8n|BigInt(n[e+2])<<16n|BigInt(n[e+3])<<24n|BigInt(n[e+4])<<32n|BigInt(n[e+5])<<40n|BigInt(n[e+6])<<48n|BigInt(n[e+7])<<56n}function fe(n,e){return BigInt(n[e])<<56n|BigInt(n[e+1])<<48n|BigInt(n[e+2])<<40n|BigInt(n[e+3])<<32n|BigInt(n[e+4])<<24n|BigInt(n[e+5])<<16n|BigInt(n[e+6])<<8n|BigInt(n[e+7])}function be(n,e,t){return t?BigInt(n[e])|BigInt(n[e+1])<<8n|BigInt(n[e+2])<<16n|BigInt(n[e+3])<<24n|BigInt(n[e+4])<<32n|BigInt(n[e+5])<<40n|BigInt(n[e+6])<<48n|BigInt(n[e+7])<<56n:BigInt(n[e])<<56n|BigInt(n[e+1])<<48n|BigInt(n[e+2])<<40n|BigInt(n[e+3])<<32n|BigInt(n[e+4])<<24n|BigInt(n[e+5])<<16n|BigInt(n[e+6])<<8n|BigInt(n[e+7])}function Be(n,e,t,r){r?(n[e]=Number(t&0xffn),n[e+1]=Number(t>>8n&0xffn),n[e+2]=Number(t>>16n&0xffn),n[e+3]=Number(t>>24n&0xffn),n[e+4]=Number(t>>32n&0xffn),n[e+5]=Number(t>>40n&0xffn),n[e+6]=Number(t>>48n&0xffn),n[e+7]=Number(t>>56n&0xffn)):(n[e]=Number(t>>56n&0xffn),n[e+1]=Number(t>>48n&0xffn),n[e+2]=Number(t>>40n&0xffn),n[e+3]=Number(t>>32n&0xffn),n[e+4]=Number(t>>24n&0xffn),n[e+5]=Number(t>>16n&0xffn),n[e+6]=Number(t>>8n&0xffn),n[e+7]=Number(t&0xffn))}function M(n,e,t){const r=(()=>r);return Object.assign(r,w(n,"byob",e,t)),r}const He=M(1,(n,{buffer:e,index:t})=>{e[t]=n},function*(n,e){return(yield*n(e.readExactly(1)))[0]}),Ge=M(2,(n,{buffer:e,index:t,littleEndian:r})=>{xe(e,t,n,r)},function*(n,e,{littleEndian:t}){const r=yield*n(e.readExactly(2));return me(r,0,t)}),Je=M(4,(n,{buffer:e,index:t,littleEndian:r})=>{ae(e,t,n,r)},function*(n,e,{littleEndian:t}){const r=yield*n(e.readExactly(4));return ie(r,0,t)}),Ke=M(4,(n,{buffer:e,index:t,littleEndian:r})=>{we(e,t,n,r)},function*(n,e,{littleEndian:t}){const r=yield*n(e.readExactly(4));return ye(r,0,t)}),Qe=M(8,(n,{buffer:e,index:t,littleEndian:r})=>{Be(e,t,n,r)},function*(n,e,{littleEndian:t}){const r=yield*n(e.readExactly(8));return be(r,0,t)}),{TextEncoder:Ee,TextDecoder:ze}=globalThis,Ie=new Ee,Se=new ze;function Ue(n){return Ie.encode(n)}function qe(n){return Se.decode(n)}const Ve=(n=>{const e=le(n,{convert:qe,back:Ue});return e.as=()=>e,e});class te extends f{constructor(e,t,r){let i,a=!1;const s=new se;super({start:u=>{const o=e({abortSignal:s.signal,enqueue:async d=>{if(r==null||r({source:"producer",operation:"enqueue",value:d,phase:"start"}),s.signal.aborted){r==null||r({source:"producer",operation:"enqueue",value:d,phase:"ignored"});return}if(u.desiredSize===null){u.enqueue(d);return}if(a){a=!1,u.enqueue(d),r==null||r({source:"producer",operation:"enqueue",value:d,phase:"complete"});return}if(u.desiredSize<=0&&(r==null||r({source:"producer",operation:"enqueue",value:d,phase:"waiting"}),i=new F,await i.promise,s.signal.aborted)){r==null||r({source:"producer",operation:"enqueue",value:d,phase:"ignored"});return}u.enqueue(d),r==null||r({source:"producer",operation:"enqueue",value:d,phase:"complete"})},close(){if(r==null||r({source:"producer",operation:"close",explicit:!0,phase:"start"}),s.signal.aborted){r==null||r({source:"producer",operation:"close",explicit:!0,phase:"ignored"});return}u.close(),r==null||r({source:"producer",operation:"close",explicit:!0,phase:"complete"})},error(d){r==null||r({source:"producer",operation:"error",explicit:!0,phase:"start"}),u.error(d),r==null||r({source:"producer",operation:"error",explicit:!0,phase:"complete"})}});o&&"then"in o&&o.then(()=>{r==null||r({source:"producer",operation:"close",explicit:!1,phase:"start"});try{u.close(),r==null||r({source:"producer",operation:"close",explicit:!1,phase:"complete"})}catch{r==null||r({source:"producer",operation:"close",explicit:!1,phase:"ignored"})}},d=>{r==null||r({source:"producer",operation:"error",explicit:!1,phase:"start"}),u.error(d),r==null||r({source:"producer",operation:"error",explicit:!1,phase:"complete"})})},pull:()=>{r==null||r({source:"consumer",operation:"pull",phase:"start"}),i?i.resolve():(t==null?void 0:t.highWaterMark)===0&&(a=!0),r==null||r({source:"consumer",operation:"pull",phase:"complete"})},cancel:u=>{r==null||r({source:"consumer",operation:"cancel",phase:"start"}),s.abort(u),i==null||i.resolve(),r==null||r({source:"consumer",operation:"cancel",phase:"complete"})}},t)}}function Xe(n){try{return n.close(),!0}catch{return!1}}async function We(n){try{return await n.cancel(),!0}catch{return!1}}var E,z,I,S,U,V,X;class Ae{constructor(e){b(this,U);b(this,E);b(this,z,0);b(this,I,0);b(this,S,0);x(this,"stream");x(this,"reader");x(this,"readExactly",$(function*(e,t){let r,i=0;const a=D(this,U,V).call(this,t);if(a){if(a.length===t)return a;r=new Uint8Array(t),r.set(a,i),i+=a.length,t-=a.length}else r=new Uint8Array(t);for(;t>0;){const s=yield*e(D(this,U,X).call(this,t));r.set(s,i),i+=s.length,t-=s.length}return r}));this.stream=e,this.reader=e.getReader()}get position(){return c(this,S)}iterateExactly(e){let t=c(this,E)?0:1;return{next:()=>{switch(t){case 0:{const r=D(this,U,V).call(this,e);return r.length===e?t=2:(e-=r.length,t=1),{done:!1,value:r}}case 1:return t=3,{done:!1,value:D(this,U,X).call(this,e).then(r=>(r.length===e?t=2:(e-=r.length,t=1),r))};case 2:return{done:!0,value:void 0};case 3:throw new Error("Can't call `next` before previous Promise resolves");default:throw new Error("unreachable")}}}}release(){return c(this,I)>0?new te(async e=>{const t=c(this,E).subarray(c(this,z));for(await e.enqueue(t),e.abortSignal.addEventListener("abort",()=>{We(this.reader)});;){const{done:r,value:i}=await this.reader.read();if(r)return;await e.enqueue(i)}}):(this.reader.releaseLock(),this.stream)}async cancel(e){await this.reader.cancel(e)}}E=new WeakMap,z=new WeakMap,I=new WeakMap,S=new WeakMap,U=new WeakSet,V=function(e){if(!c(this,E))return;const t=c(this,E).subarray(c(this,z),c(this,z)+e);return c(this,I)>e?(l(this,S,c(this,S)+e),l(this,z,c(this,z)+e),l(this,I,c(this,I)-e),t):(l(this,S,c(this,S)+c(this,I)),l(this,E,void 0),l(this,z,0),l(this,I,0),t)},X=async function(e){const{done:t,value:r}=await this.reader.read();if(t)throw new O;return r.length>e?(l(this,E,r),l(this,z,e),l(this,I,r.length-e),l(this,S,c(this,S)+e),r.subarray(0,e)):(l(this,S,c(this,S)+r.length),r)};var P,C;class Ne{constructor(e){b(this,P);b(this,C);let t,r;const i=new Ae(new te(a=>{t=a}));l(this,P,new f({async pull(a){try{const s=await e(i);a.enqueue(s)}catch(s){if(s instanceof ee){a.close();return}throw s}},cancel:a=>r.error(a)})),l(this,C,new Y({start(a){r=a},async write(a){await t.enqueue(a)},abort(){t.close()},close(){t.close()}}))}get readable(){return c(this,P)}get writable(){return c(this,C)}}P=new WeakMap,C=new WeakMap;class H extends f{static async enqueue(e,t){const r=new W(t);e.enqueue(r),await r.consumed}constructor(e,t){let r,i;t&&(i={},"highWaterMark"in t&&(i.highWaterMark=t.highWaterMark),"size"in t&&(i.size=a=>t.size(a.value))),super({start(a){var s;return r={enqueue(u){return H.enqueue(a,u)},close(){a.close()},error(u){a.error(u)}},(s=e.start)==null?void 0:s.call(e,r)},pull(){var a;return(a=e.pull)==null?void 0:a.call(e,r)},cancel(a){var s;return(s=e.cancel)==null?void 0:s.call(e,a)}},i)}}class je extends f{constructor(e,t,r){const i=e.getReader({mode:"byob"});let a=new Uint8Array(t);super({async pull(s){const{done:u,value:o}=await i.read(a,{min:r});if(u){s.close();return}await H.enqueue(s,o),a=new Uint8Array(o.buffer)},cancel(s){return i.cancel(s)}})}}class Re extends Y{constructor(e){const t=e.getWriter();super({write(r){return r.tryConsume(i=>t.write(i))},abort(r){return t.abort(r)},close(){return t.close()}})}}class Te extends Y{static async write(e,t){const r=new W(t);await e.write(r),await r.consumed}constructor(e,t){let r;t&&(r={},"highWaterMark"in t&&(r.highWaterMark=t.highWaterMark),"size"in t&&(r.size=i=>t.size(i instanceof W?i.value:i))),super({start(i){var a;return(a=e.start)==null?void 0:a.call(e,i)},write(i,a){return i.tryConsume(s=>{var u;return(u=e.write)==null?void 0:u.call(e,s,a)})},abort(i){var a;return(a=e.abort)==null?void 0:a.call(e,i)},close(){var i;return(i=e.close)==null?void 0:i.call(e)}},r)}}const{console:_}=globalThis,De=(()=>{var n;return((n=_==null?void 0:_.createTask)==null?void 0:n.bind(_))??(()=>({run(e){return e()}}))})();var L,m;class W{constructor(e){b(this,L);b(this,m);x(this,"value");x(this,"consumed");l(this,L,De("Consumable")),this.value=e,l(this,m,new F),this.consumed=c(this,m).promise}consume(){c(this,m).resolve()}error(e){c(this,m).reject(e)}tryConsume(e){try{let t=c(this,L).run(()=>e(this.value));return Z(t)?t=t.then(r=>(c(this,m).resolve(),r),r=>{throw c(this,m).reject(r),r}):c(this,m).resolve(),t}catch(t){throw c(this,m).reject(t),t}}}L=new WeakMap,m=new WeakMap,x(W,"WritableStream",Te),x(W,"WrapWritableStream",Re),x(W,"ReadableStream",H),x(W,"WrapByteReadableStream",je);class Ye extends Ne{constructor(e){super(t=>e.deserialize(t))}}export{Ae as B,W as C,R as E,te as P,ee as S,ze as T,He as a,le as b,Ye as c,Ve as d,Ue as e,qe as f,Qe as g,Le as h,fe as i,Ke as j,$ as k,Xe as l,_e as m,O as n,Ge as o,w as p,me as q,xe as r,he as s,We as t,Je as u,Me as v};

var te=Object.defineProperty;var $=n=>{throw TypeError(n)};var re=(n,r,t)=>r in n?te(n,r,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[r]=t;var y=(n,r,t)=>re(n,typeof r!="symbol"?r+"":r,t),G=(n,r,t)=>r.has(n)||$("Cannot "+t);var u=(n,r,t)=>(G(n,r,"read from private field"),t?t.call(n):r.get(n)),w=(n,r,t)=>r.has(n)?$("Cannot add the same private member more than once"):r instanceof WeakSet?r.add(n):r.set(n,t),d=(n,r,t,e)=>(G(n,r,"write to private field"),e?e.call(n,t):r.set(n,t),t),C=(n,r,t)=>(G(n,r,"access private method"),t);import{R as _,A as ne,P as k,W as V}from"./stream-BT4ImN5b.js";function X(n){return typeof n=="object"&&n!==null&&"then"in n}function J(n,r){for(;;){const{done:t,value:e}=n.next(r);if(t)return e;if(X(e))return e.then(s=>J(n,{resolved:s}),s=>J(n,{error:s}));r=e}}function Y(n,r){function t(...e){const s=n.call(this,function*(a){if(X(a)){const i=yield a;if("resolved"in i)return i.resolved;throw i.error}return a},...e);return J(s,void 0)}return t}function se(n){return(r,t)=>{if("buffer"in t){const e=n(r,t);return t.buffer.set(e,t.index),e.length}else return n(r,t)}}function ae(n,r){return(t,e)=>{if("buffer"in e)return e.index??(e.index=0),r(t,e),n;{const s=new Uint8Array(n);return r(t,{buffer:s,index:0,littleEndian:e.littleEndian}),s}}}function ie(n,r,t,e,s){const a={size:n,type:r,serialize:r==="default"?se(t):ae(n,t),deserialize:Y(e),omitInit:s==null?void 0:s.omitInit};return s!=null&&s.init&&(a.init=s.init),a}const m=ie,j=new Uint8Array(0);function ue(n,r){return typeof n=="number"?r?n===0?m(0,"byob",()=>{},function*(){return r.convert(j)}):m(n,"byob",(t,{buffer:e,index:s})=>{e.set(t.slice(0,n),s)},function*(t,e){const s=yield*t(e.readExactly(n));return r.convert(s)},{init(t){return r.back(t)}}):n===0?m(0,"byob",()=>{},function*(){return j}):m(n,"byob",(t,{buffer:e,index:s})=>{e.set(t.slice(0,n),s)},function*(t,e){return e.readExactly(n)}):(typeof n=="object"||typeof n=="function")&&"serialize"in n?r?m(n.size,"default",(t,{littleEndian:e})=>{if(n.type==="default"){const s=n.serialize(t.length,{littleEndian:e}),a=new Uint8Array(s.length+t.length);return a.set(s,0),a.set(t,s.length),a}else{const s=new Uint8Array(n.size+t.length);return n.serialize(t.length,{buffer:s,index:0,littleEndian:e}),s.set(t,n.size),s}},function*(t,e,s){const a=yield*t(n.deserialize(e,s)),i=yield*t(e.readExactly(a));return r.convert(i)},{init(t){return r.back(t)}}):m(n.size,"default",(t,{littleEndian:e})=>{if(n.type==="default"){const s=n.serialize(t.length,{littleEndian:e}),a=new Uint8Array(s.length+t.length);return a.set(s,0),a.set(t,s.length),a}else{const s=new Uint8Array(n.size+t.length);return n.serialize(t.length,{buffer:s,index:0,littleEndian:e}),s.set(t,n.size),s}},function*(t,e,s){const a=yield*t(n.deserialize(e,s));return yield*t(e.readExactly(a))}):typeof n=="string"?r?m(0,"default",t=>t,function*(t,e,{dependencies:s}){const a=s[n];return a===0?j:e.readExactly(a)},{init(t,e){const s=r.back(t);return e[n]=s.length,s}}):m(0,"default",t=>t,function*(t,e,{dependencies:s}){const a=s[n];return a===0?j:e.readExactly(a)},{init(t,e){e[n]=t.length}}):r?m(0,"default",t=>t,function*(t,e,{dependencies:s}){const a=s[n.field],i=n.convert(a);return i===0?j:e.readExactly(i)},{init(t,e){const s=r.back(t);return e[n.field]=n.back(s.length),s}}):m(0,"default",t=>t,function*(t,e,{dependencies:s}){const a=s[n.field],i=n.convert(a);return i===0?j:e.readExactly(i)},{init(t,e){e[n.field]=n.back(t.length)}})}const me=ue;class F extends Error{constructor(){super("ExactReadable ended")}}class O extends Error{constructor(r){super(r)}}class ce extends O{constructor(){super("The underlying readable was ended before the struct was fully deserialized")}}class g extends O{constructor(){super("The underlying readable doesn't contain any more struct")}}function xe(n,r){const t=Object.entries(n);let e=0,s=!0;for(const[,c]of t)e+=c.size,s&&c.type!=="byob"&&(s=!1);const a=r.littleEndian,i=r.extra?Object.getOwnPropertyDescriptors(r.extra):void 0;return{littleEndian:a,fields:n,extra:r.extra,type:s?"byob":"default",size:e,serialize(c,o){var Z;const f={...c};for(const[h,p]of t)if(h in f&&"init"in p){const B=(Z=p.init)==null?void 0:Z.call(p,f[h],f);B!==void 0&&(f[h]=B)}const l=new Array(t.length),U=new Array(t.length);{const h={littleEndian:a};for(const[p,[B,N]]of t.entries())N.type==="byob"?l[p]=N.size:(U[p]=N.serialize(f[B],h),l[p]=U[p].length)}const x=l.reduce((h,p)=>h+p,0);let R,A,P;if(o instanceof Uint8Array){if(o.length<x)throw new Error("Buffer too small");R=!0,A=o,P=0}else if(typeof o=="object"&&"buffer"in o){if(R=!0,A=o.buffer,P=o.index??0,A.length-P<x)throw new Error("Buffer too small")}else R=!1,A=new Uint8Array(x),P=0;const H={buffer:A,index:P,littleEndian:a};for(const[h,[p,B]]of t.entries())U[h]?A.set(U[h],H.index):B.serialize(f[p],H),H.index+=l[h];return R?x:A},deserialize:Y(function*(c,o){const f=o.position,l={},U={dependencies:l,littleEndian:a};try{for(const[x,R]of t)l[x]=yield*c(R.deserialize(o,U))}catch(x){throw x instanceof F?o.position===f?new g:new ce:x}return i&&Object.defineProperties(l,i),r.postDeserialize?r.postDeserialize.call(l,l):l})}}class ee extends _{constructor(r,t,e){let s,a=!1;const i=new ne;super({start:c=>{const o=r({abortSignal:i.signal,enqueue:async f=>{if(e==null||e({source:"producer",operation:"enqueue",value:f,phase:"start"}),i.signal.aborted){e==null||e({source:"producer",operation:"enqueue",value:f,phase:"ignored"});return}if(c.desiredSize===null){c.enqueue(f);return}if(a){a=!1,c.enqueue(f),e==null||e({source:"producer",operation:"enqueue",value:f,phase:"complete"});return}if(c.desiredSize<=0&&(e==null||e({source:"producer",operation:"enqueue",value:f,phase:"waiting"}),s=new k,await s.promise,i.signal.aborted)){e==null||e({source:"producer",operation:"enqueue",value:f,phase:"ignored"});return}c.enqueue(f),e==null||e({source:"producer",operation:"enqueue",value:f,phase:"complete"})},close(){if(e==null||e({source:"producer",operation:"close",explicit:!0,phase:"start"}),i.signal.aborted){e==null||e({source:"producer",operation:"close",explicit:!0,phase:"ignored"});return}c.close(),e==null||e({source:"producer",operation:"close",explicit:!0,phase:"complete"})},error(f){e==null||e({source:"producer",operation:"error",explicit:!0,phase:"start"}),c.error(f),e==null||e({source:"producer",operation:"error",explicit:!0,phase:"complete"})}});o&&"then"in o&&o.then(()=>{e==null||e({source:"producer",operation:"close",explicit:!1,phase:"start"});try{c.close(),e==null||e({source:"producer",operation:"close",explicit:!1,phase:"complete"})}catch{e==null||e({source:"producer",operation:"close",explicit:!1,phase:"ignored"})}},f=>{e==null||e({source:"producer",operation:"error",explicit:!1,phase:"start"}),c.error(f),e==null||e({source:"producer",operation:"error",explicit:!1,phase:"complete"})})},pull:()=>{e==null||e({source:"consumer",operation:"pull",phase:"start"}),s?s.resolve():(t==null?void 0:t.highWaterMark)===0&&(a=!0),e==null||e({source:"consumer",operation:"pull",phase:"complete"})},cancel:c=>{e==null||e({source:"consumer",operation:"cancel",phase:"start"}),i.abort(c),s==null||s.resolve(),e==null||e({source:"consumer",operation:"cancel",phase:"complete"})}},t)}}function ze(n){try{return n.close(),!0}catch{return!1}}async function fe(n){try{return await n.cancel(),!0}catch{return!1}}var z,E,S,q,W,K,Q;class oe{constructor(r){w(this,W);w(this,z);w(this,E,0);w(this,S,0);w(this,q,0);y(this,"stream");y(this,"reader");y(this,"readExactly",Y(function*(r,t){let e,s=0;const a=C(this,W,K).call(this,t);if(a){if(a.length===t)return a;e=new Uint8Array(t),e.set(a,s),s+=a.length,t-=a.length}else e=new Uint8Array(t);for(;t>0;){const i=yield*r(C(this,W,Q).call(this,t));e.set(i,s),s+=i.length,t-=i.length}return e}));this.stream=r,this.reader=r.getReader()}get position(){return u(this,q)}iterateExactly(r){let t=u(this,z)?0:1;return{next:()=>{switch(t){case 0:{const e=C(this,W,K).call(this,r);return e.length===r?t=2:(r-=e.length,t=1),{done:!1,value:e}}case 1:return t=3,{done:!1,value:C(this,W,Q).call(this,r).then(e=>(e.length===r?t=2:(r-=e.length,t=1),e))};case 2:return{done:!0,value:void 0};case 3:throw new Error("Can't call `next` before previous Promise resolves");default:throw new Error("unreachable")}}}}release(){return u(this,S)>0?new ee(async r=>{const t=u(this,z).subarray(u(this,E));for(await r.enqueue(t),r.abortSignal.addEventListener("abort",()=>{fe(this.reader)});;){const{done:e,value:s}=await this.reader.read();if(e)return;await r.enqueue(s)}}):(this.reader.releaseLock(),this.stream)}async cancel(r){await this.reader.cancel(r)}}z=new WeakMap,E=new WeakMap,S=new WeakMap,q=new WeakMap,W=new WeakSet,K=function(r){if(!u(this,z))return;const t=u(this,z).subarray(u(this,E),u(this,E)+r);return u(this,S)>r?(d(this,q,u(this,q)+r),d(this,E,u(this,E)+r),d(this,S,u(this,S)-r),t):(d(this,q,u(this,q)+u(this,S)),d(this,z,void 0),d(this,E,0),d(this,S,0),t)},Q=async function(r){const{done:t,value:e}=await this.reader.read();if(t)throw new F;return e.length>r?(d(this,z,e),d(this,E,r),d(this,S,e.length-r),d(this,q,u(this,q)+r),e.subarray(0,r)):(d(this,q,u(this,q)+e.length),e)};var M,T;class de{constructor(r){w(this,M);w(this,T);let t,e;const s=new oe(new ee(a=>{t=a}));d(this,M,new _({async pull(a){try{const i=await r(s);a.enqueue(i)}catch(i){if(i instanceof g){a.close();return}throw i}},cancel:a=>e.error(a)})),d(this,T,new V({start(a){e=a},async write(a){await t.enqueue(a)},abort(){t.close()},close(){t.close()}}))}get readable(){return u(this,M)}get writable(){return u(this,T)}}M=new WeakMap,T=new WeakMap;class I extends _{static async enqueue(r,t){const e=new v(t);r.enqueue(e),await e.consumed}constructor(r,t){let e,s;t&&(s={},"highWaterMark"in t&&(s.highWaterMark=t.highWaterMark),"size"in t&&(s.size=a=>t.size(a.value))),super({start(a){var i;return e={enqueue(c){return I.enqueue(a,c)},close(){a.close()},error(c){a.error(c)}},(i=r.start)==null?void 0:i.call(r,e)},pull(){var a;return(a=r.pull)==null?void 0:a.call(r,e)},cancel(a){var i;return(i=r.cancel)==null?void 0:i.call(r,a)}},s)}}class pe extends _{constructor(r,t,e){const s=r.getReader({mode:"byob"});let a=new Uint8Array(t);super({async pull(i){const{done:c,value:o}=await s.read(a,{min:e});if(c){i.close();return}await I.enqueue(i,o),a=new Uint8Array(o.buffer)},cancel(i){return s.cancel(i)}})}}class le extends V{constructor(r){const t=r.getWriter();super({write(e){return e.tryConsume(s=>t.write(s))},abort(e){return t.abort(e)},close(){return t.close()}})}}class he extends V{static async write(r,t){const e=new v(t);await r.write(e),await e.consumed}constructor(r,t){let e;t&&(e={},"highWaterMark"in t&&(e.highWaterMark=t.highWaterMark),"size"in t&&(e.size=s=>t.size(s instanceof v?s.value:s))),super({start(s){var a;return(a=r.start)==null?void 0:a.call(r,s)},write(s,a){return s.tryConsume(i=>{var c;return(c=r.write)==null?void 0:c.call(r,i,a)})},abort(s){var a;return(a=r.abort)==null?void 0:a.call(r,s)},close(){var s;return(s=r.close)==null?void 0:s.call(r)}},e)}}const{console:L}=globalThis,be=(()=>{var n;return((n=L==null?void 0:L.createTask)==null?void 0:n.bind(L))??(()=>({run(r){return r()}}))})();var D,b;class v{constructor(r){w(this,D);w(this,b);y(this,"value");y(this,"consumed");d(this,D,be("Consumable")),this.value=r,d(this,b,new k),this.consumed=u(this,b).promise}consume(){u(this,b).resolve()}error(r){u(this,b).reject(r)}tryConsume(r){try{let t=u(this,D).run(()=>r(this.value));return X(t)?t=t.then(e=>(u(this,b).resolve(),e),e=>{throw u(this,b).reject(e),e}):u(this,b).resolve(),t}catch(t){throw u(this,b).reject(t),t}}}D=new WeakMap,b=new WeakMap,y(v,"WritableStream",he),y(v,"WrapWritableStream",le),y(v,"ReadableStream",I),y(v,"WrapByteReadableStream",pe);class Ee extends de{constructor(r){super(t=>r.deserialize(t))}}export{oe as B,v as C,j as E,ee as P,g as S,Ee as a,me as b,Y as c,ze as d,F as e,m as f,de as g,be as h,xe as s,fe as t};

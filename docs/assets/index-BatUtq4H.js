var yr=Object.defineProperty;var l=a=>{throw TypeError(a)};var vr=(a,s,e)=>s in a?yr(a,s,{enumerable:!0,configurable:!0,writable:!0,value:e}):a[s]=e;var u=(a,s,e)=>vr(a,typeof s!="symbol"?s+"":s,e),G=(a,s,e)=>s.has(a)||l("Cannot "+e);var c=(a,s,e)=>(G(a,s,"read from private field"),e?e.call(a):s.get(a)),d=(a,s,e)=>s.has(a)?l("Cannot add the same private member more than once"):s instanceof WeakSet?s.add(a):s.set(a,e),w=(a,s,e,r)=>(G(a,s,"write to private field"),r?r.call(a,e):s.set(a,e),e),v=(a,s,e)=>(G(a,s,"access private method"),e);import{D as gr,S as fr,a as pr,b as Sr,c as mr,d as _r,e as br,f as xr,g as Cr,h as Er,i as Ar,j as Dr,k as Rr,l as Tr,t as O,m as Pr,n as Nr,o as qr,p as Br,q as Mr,r as kr,s as zr,u as Hr,v as Wr,w as Fr,x as Vr,y as $r,z as Ir,A as Lr,B as rr,C as Ur}from"./3_3_2-jOTdHFWM.js";import{T as er,A as jr,W as Kr}from"./stream-CeehbguB.js";import{S as V,h as Xr,a as Yr,A as Gr}from"./h265-BZeEvzU-.js";import{S as Jr}from"./sticky-event-emitter-B3ySTSV4.js";import{d as Qr,c as sr,N as Zr,T as lr}from"./reverse-DeNl7JEN.js";import{B as ar,P as J,n as Or,t as re}from"./struct-deserialize-DCusmjXY.js";class ee extends er{constructor(s){super({transform(e,r){s(e),r.enqueue(e)}})}}class se extends er{constructor(s){let e;super({transform(r,t){e&&(r=e+r,e=void 0);let o=0;for(;o<r.length;){const h=r.indexOf(s,o);if(h===-1){e=r.substring(o);break}t.enqueue(r.substring(o,h)),o=h+1}},flush(r){e&&r.enqueue(e)}})}}const ae="scrcpy";class tr{constructor(s,e){u(this,"adb");u(this,"options");u(this,"socketName");this.adb=s,this.options=e,this.socketName=this.getSocketName()}initialize(){}getSocketName(){let s="localabstract:"+ae;return this.options.scid!==void 0&&(s+="_"+this.options.scid.padStart(8,"0")),s}dispose(){}}var P,p,ur,$;class L extends tr{constructor(){super(...arguments);d(this,p);d(this,P,!1)}async getStreams(){let{sendDummyByte:e}=this.options;const r={};if(this.options.video){const t=await v(this,p,$).call(this,e);r.video=t.readable,e=!1}if(this.options.audio){const t=await v(this,p,$).call(this,e);r.audio=t.readable,e=!1}if(this.options.control){const t=await v(this,p,$).call(this,e);r.control=t,e=!1}return r}dispose(){w(this,P,!0)}}P=new WeakMap,p=new WeakSet,ur=function(){return this.adb.createSocket(this.socketName)},$=async function(e){for(let r=0;!c(this,P)&&r<100;r+=1)try{const t=await v(this,p,ur).call(this);if(e){const o=new ar(t.readable);return await o.readExactly(1),{readable:o.release(),writable:t.writable}}return t}catch{await Qr(100)}throw new Error("Can't connect to server after 100 retries")};var N,q,D,I;class U extends tr{constructor(){super(...arguments);d(this,D);d(this,N);d(this,q)}async initialize(){await this.adb.reverse.remove(this.socketName).catch(t=>{if(t instanceof sr)throw t});let e;const r=new J(t=>{e=t});w(this,N,r.getReader()),w(this,q,await this.adb.reverse.add(this.socketName,async t=>{await e.enqueue(t)}))}async getStreams(){const e={};if(this.options.video){const r=await v(this,D,I).call(this);e.video=r.readable}if(this.options.audio){const r=await v(this,D,I).call(this);e.audio=r.readable}if(this.options.control){const r=await v(this,D,I).call(this);e.control=r}return e}dispose(){this.adb.reverse.remove(c(this,q)).catch(Zr)}}N=new WeakMap,q=new WeakMap,D=new WeakSet,I=async function(){return(await c(this,N).read()).value};function _(a,s){const e={scid:void 0,video:!0,audio:!1,control:!0,sendDummyByte:!0};return s.tunnelForward?new L(a,e):new U(a,e)}var B,M,k,x,C,E,S,or,nr,cr;class te{constructor(s,e,r){d(this,S);d(this,B);d(this,M);d(this,k);d(this,x,new Jr);d(this,C,0);d(this,E,0);w(this,B,s),w(this,M,e),w(this,k,r.pipeThrough(c(this,B).createMediaStreamTransformer()).pipeThrough(new ee(t=>{if(t.type==="configuration")switch(e.codec){case V.H264:v(this,S,or).call(this,t.data);break;case V.H265:v(this,S,nr).call(this,t.data);break;case V.AV1:break}else e.codec===V.AV1&&v(this,S,cr).call(this,t.data)})))}get metadata(){return c(this,M)}get stream(){return c(this,k)}get sizeChanged(){return c(this,x).event}get width(){return c(this,C)}get height(){return c(this,E)}}B=new WeakMap,M=new WeakMap,k=new WeakMap,x=new WeakMap,C=new WeakMap,E=new WeakMap,S=new WeakSet,or=function(s){const{croppedWidth:e,croppedHeight:r}=Xr(s);w(this,C,e),w(this,E,r),c(this,x).fire({width:e,height:r})},nr=function(s){const{croppedWidth:e,croppedHeight:r}=Yr(s);w(this,C,e),w(this,E,r),c(this,x).fire({width:e,height:r})},cr=function(s){const r=new Gr(s).searchSequenceHeaderObu();if(!r)return;const{max_frame_width_minus_1:t,max_frame_height_minus_1:o}=r,h=t+1,f=o+1;w(this,C,h),w(this,E,f),c(this,x).fire({width:h,height:f})};function ue(a){return new J(async s=>{for(const e of a)await s.enqueue(e)})}function oe(...a){return new J(async s=>{for(const e of a){const r=e.getReader();for(;;){const{done:t,value:o}=await r.read();if(t)break;await s.enqueue(o)}}})}class Q extends Error{constructor(e){super("scrcpy server exited prematurely");u(this,"output");this.output=e}}var g,R,z,H,W,F,m,hr,dr,wr;const Z=class Z{constructor({options:s,process:e,output:r,videoStream:t,audioStream:o,controlStream:h}){d(this,m);d(this,g);d(this,R);d(this,z);d(this,H);d(this,W);d(this,F);w(this,g,s),w(this,R,e),w(this,z,r),w(this,H,t?v(this,m,dr).call(this,t):void 0),w(this,W,o?v(this,m,wr).call(this,o):void 0),h&&(w(this,F,new fr(h.writable.getWriter(),s)),v(this,m,hr).call(this,h.readable).catch(()=>{}))}static async pushServer(s,e,r=gr){const t=await s.sync();try{await t.write({filename:r,file:e})}finally{await t.dispose()}}static async start(s,e,r){let t,o;try{try{t=r.createConnection(s),await t.initialize()}catch(A){if(A instanceof sr)r.value.tunnelForward=!0,t=r.createConnection(s),await t.initialize();else throw t=void 0,A}const h=["app_process","-cp",e,"/","com.genymobile.scrcpy.Server",r.version,...r.serialize()];r.spawner?o=await r.spawner.spawn(h):o=await s.subprocess.noneProtocol.spawn(h);const f=o.output.pipeThrough(new lr).pipeThrough(new se(`
`)),K=[],X=new jr,ir=f.pipeTo(new Kr({write(A){K.push(A)}}),{signal:X.signal,preventCancel:!0}).catch(A=>{if(!X.signal.aborted)throw A}),Y=await Promise.race([o.exited.then(()=>{throw new Q(K)}),t.getStreams()]);return X.abort(),await ir,new Z({options:r,process:o,output:oe(ue(K),f),videoStream:Y.video,audioStream:Y.audio,controlStream:Y.control})}catch(h){throw await(o==null?void 0:o.kill()),h}finally{t==null||t.dispose()}}static getEncoders(s,e,r){return r.setListEncoders(),r.getEncoders(s,e)}static getDisplays(s,e,r){return r.setListDisplays(),r.getDisplays(s,e)}get output(){return c(this,z)}get exited(){return c(this,R).exited}get videoStream(){return c(this,H)}get audioStream(){return c(this,W)}get controller(){return c(this,F)}get clipboard(){return c(this,g).clipboard}async close(){await c(this,R).kill()}};g=new WeakMap,R=new WeakMap,z=new WeakMap,H=new WeakMap,W=new WeakMap,F=new WeakMap,m=new WeakSet,hr=async function(s){const e=new ar(s);try{for(;;){let r;try{r=(await e.readExactly(1))[0]}catch(t){if(t instanceof Or){c(this,g).deviceMessageParsers.close();break}throw t}await c(this,g).deviceMessageParsers.parse(r,e)}}catch(r){c(this,g).deviceMessageParsers.error(r),await re(e)}},dr=async function(s){const{metadata:e,stream:r}=await c(this,g).parseVideoStreamMetadata(s);return new te(c(this,g),e,r)},wr=async function(s){if(!c(this,g).parseAudioStreamMetadata)throw new Error("parsing audio stream is not supported in this version");const e=await c(this,g).parseAudioStreamMetadata(s);switch(e.type){case"disabled":case"errored":return e;case"success":return{...e,stream:e.stream.pipeThrough(c(this,g).createMediaStreamTransformer())};default:throw new Error(`Unexpected audio metadata type ${e.type}`)}};let T=Z;async function n(a,s,e){var r;try{throw await(await T.start(a,s,e)).close(),new Error("Unexpected server output")}catch(t){if(t instanceof Q){if((r=t.output[0])!=null&&r.startsWith("[server] ERROR:"))throw t;const o=[];for(const h of t.output){const f=e.parseDisplay(h);f&&o.push(f)}return o}throw t}}class fe extends pr{constructor(e,r){super(e);u(this,"version");u(this,"spawner");this.version=(r==null?void 0:r.version)??"1.15",this.spawner=r==null?void 0:r.spawner}getDisplays(e,r){return n(e,r,this)}createConnection(e){return _(e,this.value)}}class pe extends Sr{constructor(e,r){super(e);u(this,"version");u(this,"spawner");this.version=(r==null?void 0:r.version)??"1.15.1",this.spawner=r==null?void 0:r.spawner}getDisplays(e,r){return n(e,r,this)}createConnection(e){return _(e,this.value)}}class Se extends mr{constructor(e,r){super(e);u(this,"version");u(this,"spawner");this.version=(r==null?void 0:r.version)??"1.16",this.spawner=r==null?void 0:r.spawner}getDisplays(e,r){return n(e,r,this)}createConnection(e){return _(e,this.value)}}async function b(a,s,e){const r=await T.start(a,s,e),t=[];for await(const o of r.output){const h=e.parseEncoder(o);h&&t.push(h)}return t}class me extends _r{constructor(e,r){super(e);u(this,"version");u(this,"spawner");this.version=(r==null?void 0:r.version)??"1.17",this.spawner=r==null?void 0:r.spawner}getDisplays(e,r){return n(e,r,this)}createConnection(e){return _(e,this.value)}}class _e extends br{constructor(e,r){super(e);u(this,"version");u(this,"spawner");this.version=(r==null?void 0:r.version)??"1.18",this.spawner=r==null?void 0:r.spawner}getEncoders(e,r){return b(e,r,this)}getDisplays(e,r){return n(e,r,this)}createConnection(e){return _(e,this.value)}}class be extends xr{constructor(e,r){super(e);u(this,"version");u(this,"spawner");this.version=(r==null?void 0:r.version)??"1.19",this.spawner=r==null?void 0:r.spawner}getEncoders(e,r){return b(e,r,this)}getDisplays(e,r){return n(e,r,this)}createConnection(e){return _(e,this.value)}}class xe extends Cr{constructor(e,r){super(e);u(this,"version");u(this,"spawner");this.version=(r==null?void 0:r.version)??"1.20",this.spawner=r==null?void 0:r.spawner}getEncoders(e,r){return b(e,r,this)}getDisplays(e,r){return n(e,r,this)}createConnection(e){return _(e,this.value)}}class Ce extends Er{constructor(e,r){super(e);u(this,"version");u(this,"spawner");this.version=(r==null?void 0:r.version)??"1.21",this.spawner=r==null?void 0:r.spawner}getEncoders(e,r){return b(e,r,this)}getDisplays(e,r){return n(e,r,this)}createConnection(e){return _(e,this.value)}}function j(a,s){const e={scid:void 0,video:!0,audio:!1,control:s.control,sendDummyByte:s.sendDummyByte};return s.tunnelForward?new L(a,e):new U(a,e)}class Ee extends Ar{constructor(e,r){super(e);u(this,"version");u(this,"spawner");this.version=(r==null?void 0:r.version)??"1.22",this.spawner=r==null?void 0:r.spawner}getEncoders(e,r){return b(e,r,this)}getDisplays(e,r){return n(e,r,this)}createConnection(e){return j(e,this.value)}}class Ae extends Dr{constructor(e,r){super(e);u(this,"version");u(this,"spawner");this.version=(r==null?void 0:r.version)??"1.23",this.spawner=r==null?void 0:r.spawner}getEncoders(e,r){return b(e,r,this)}getDisplays(e,r){return n(e,r,this)}createConnection(e){return j(e,this.value)}}class De extends Rr{constructor(e,r){super(e);u(this,"version");u(this,"spawner");this.version=(r==null?void 0:r.version)??"1.24",this.spawner=r==null?void 0:r.spawner}getEncoders(e,r){return b(e,r,this)}getDisplays(e,r){return n(e,r,this)}createConnection(e){return j(e,this.value)}}class Re extends Tr{constructor(e,r){super(e);u(this,"version");u(this,"spawner");this.version=(r==null?void 0:r.version)??"1.25",this.spawner=r==null?void 0:r.spawner}getEncoders(e,r){return b(e,r,this)}getDisplays(e,r){return n(e,r,this)}createConnection(e){return j(e,this.value)}}function ne(a,s){const e={scid:O(s.scid,void 0),video:!0,audio:s.audio,control:s.control,sendDummyByte:s.sendDummyByte};return s.tunnelForward?new L(a,e):new U(a,e)}async function i(a,s,e){var r;try{throw await(await T.start(a,s,e)).close(),new Error("Unexpected server output")}catch(t){if(t instanceof Q){if((r=t.output[0])!=null&&r.startsWith("[server] ERROR:"))throw t;const o=[];for(const h of t.output){const f=e.parseEncoder(h);f&&o.push(f)}return o}throw t}}class Te extends Pr{constructor(e,r){super(e);u(this,"version");u(this,"spawner");this.version=(r==null?void 0:r.version)??"2.0",this.spawner=r==null?void 0:r.spawner}getEncoders(e,r){return i(e,r,this)}getDisplays(e,r){return n(e,r,this)}createConnection(e){return ne(e,this.value)}}function y(a,s){const e={scid:O(s.scid,void 0),video:s.video,audio:s.audio,control:s.control,sendDummyByte:s.sendDummyByte};return s.tunnelForward?new L(a,e):new U(a,e)}class Pe extends Nr{constructor(e,r){super(e);u(this,"version");u(this,"spawner");this.version=(r==null?void 0:r.version)??"2.1",this.spawner=r==null?void 0:r.spawner}getEncoders(e,r){return i(e,r,this)}getDisplays(e,r){return n(e,r,this)}createConnection(e){return y(e,this.value)}}class Ne extends qr{constructor(e,r){super(e);u(this,"version");u(this,"spawner");this.version=(r==null?void 0:r.version)??"v2.2",this.spawner=r==null?void 0:r.spawner}getEncoders(e,r){return i(e,r,this)}getDisplays(e,r){return n(e,r,this)}createConnection(e){return y(e,this.value)}}class qe extends Br{constructor(e,r){super(e);u(this,"version");u(this,"spawner");this.version=(r==null?void 0:r.version)??"2.3",this.spawner=r==null?void 0:r.spawner}getEncoders(e,r){return i(e,r,this)}getDisplays(e,r){return n(e,r,this)}createConnection(e){return y(e,this.value)}}class Be extends Mr{constructor(e,r){super(e);u(this,"version");u(this,"spawner");this.version=(r==null?void 0:r.version)??"2.4",this.spawner=r==null?void 0:r.spawner}getEncoders(e,r){return i(e,r,this)}getDisplays(e,r){return n(e,r,this)}createConnection(e){return y(e,this.value)}}class Me extends kr{constructor(e,r){super(e);u(this,"version");u(this,"spawner");this.version=(r==null?void 0:r.version)??"2.5",this.spawner=r==null?void 0:r.spawner}getEncoders(e,r){return i(e,r,this)}getDisplays(e,r){return n(e,r,this)}createConnection(e){return y(e,this.value)}}class ke extends zr{constructor(e,r){super(e);u(this,"version");u(this,"spawner");this.version=(r==null?void 0:r.version)??"2.6",this.spawner=r==null?void 0:r.spawner}getEncoders(e,r){return i(e,r,this)}getDisplays(e,r){return n(e,r,this)}createConnection(e){return y(e,this.value)}}class ze extends Hr{constructor(e,r){super(e);u(this,"version");u(this,"spawner");this.version=(r==null?void 0:r.version)??"2.7",this.spawner=r==null?void 0:r.spawner}getEncoders(e,r){return i(e,r,this)}getDisplays(e,r){return n(e,r,this)}createConnection(e){return y(e,this.value)}}class He extends Wr{constructor(e,r){super(e);u(this,"version");u(this,"spawner");this.version=(r==null?void 0:r.version)??"3.0",this.spawner=r==null?void 0:r.spawner}getEncoders(e,r){return i(e,r,this)}getDisplays(e,r){return n(e,r,this)}createConnection(e){return y(e,this.value)}}class We extends Fr{constructor(e,r){super(e);u(this,"version");u(this,"spawner");this.version=(r==null?void 0:r.version)??"3.0.1",this.spawner=r==null?void 0:r.spawner}getEncoders(e,r){return i(e,r,this)}getDisplays(e,r){return n(e,r,this)}createConnection(e){return y(e,this.value)}}class Fe extends Vr{constructor(e,r){super(e);u(this,"version");u(this,"spawner");this.version=(r==null?void 0:r.version)??"3.0.2",this.spawner=r==null?void 0:r.spawner}getEncoders(e,r){return i(e,r,this)}getDisplays(e,r){return n(e,r,this)}createConnection(e){return y(e,this.value)}}class Ve extends $r{constructor(e,r){super(e);u(this,"version");u(this,"spawner");this.version=(r==null?void 0:r.version)??"3.1",this.spawner=r==null?void 0:r.spawner}getEncoders(e,r){return i(e,r,this)}getDisplays(e,r){return n(e,r,this)}createConnection(e){return y(e,this.value)}}class $e extends Ir{constructor(e,r){super(e);u(this,"version");u(this,"spawner");this.version=(r==null?void 0:r.version)??"3.2",this.spawner=r==null?void 0:r.spawner}getEncoders(e,r){return i(e,r,this)}getDisplays(e,r){return n(e,r,this)}createConnection(e){return y(e,this.value)}}class Ie extends Lr{constructor(e,r){super(e);u(this,"version");u(this,"spawner");this.version=(r==null?void 0:r.version)??"3.3",this.spawner=r==null?void 0:r.spawner}getEncoders(e,r){return i(e,r,this)}getDisplays(e,r){return n(e,r,this)}createConnection(e){return y(e,this.value)}}class Le extends rr{constructor(e,r){super(e);u(this,"version");u(this,"spawner");this.version=(r==null?void 0:r.version)??"3.3.1",this.spawner=r==null?void 0:r.spawner}getEncoders(e,r){return i(e,r,this)}getDisplays(e,r){return n(e,r,this)}createConnection(e){return y(e,this.value)}}class Ue extends Ur{constructor(e,r){super(e);u(this,"version");u(this,"spawner");this.version=(r==null?void 0:r.version)??"3.3.2",this.spawner=r==null?void 0:r.spawner}getEncoders(e,r){return i(e,r,this)}getDisplays(e,r){return n(e,r,this)}createConnection(e){return y(e,this.value)}}class ce extends rr{constructor(e,r){super(e);u(this,"version");u(this,"spawner");this.version=(r==null?void 0:r.version)??"3.3.3",this.spawner=r==null?void 0:r.spawner}getEncoders(e,r){return i(e,r,this)}getDisplays(e,r){return n(e,r,this)}createConnection(e){return y(e,this.value)}}class je extends ce{constructor(s,e){super(s,e)}}export{T as AdbScrcpyClient,tr as AdbScrcpyConnection,Q as AdbScrcpyExitedError,L as AdbScrcpyForwardConnection,fe as AdbScrcpyOptions1_15,pe as AdbScrcpyOptions1_15_1,Se as AdbScrcpyOptions1_16,me as AdbScrcpyOptions1_17,_e as AdbScrcpyOptions1_18,be as AdbScrcpyOptions1_19,xe as AdbScrcpyOptions1_20,Ce as AdbScrcpyOptions1_21,Ee as AdbScrcpyOptions1_22,Ae as AdbScrcpyOptions1_23,De as AdbScrcpyOptions1_24,Re as AdbScrcpyOptions1_25,Te as AdbScrcpyOptions2_0,Pe as AdbScrcpyOptions2_1,Ne as AdbScrcpyOptions2_2,qe as AdbScrcpyOptions2_3,Be as AdbScrcpyOptions2_4,Me as AdbScrcpyOptions2_5,ke as AdbScrcpyOptions2_6,ze as AdbScrcpyOptions2_7,He as AdbScrcpyOptions3_0,We as AdbScrcpyOptions3_0_1,Fe as AdbScrcpyOptions3_0_2,Ve as AdbScrcpyOptions3_1,$e as AdbScrcpyOptions3_2,Ie as AdbScrcpyOptions3_3,Le as AdbScrcpyOptions3_3_1,Ue as AdbScrcpyOptions3_3_2,ce as AdbScrcpyOptions3_3_3,je as AdbScrcpyOptionsLatest,U as AdbScrcpyReverseConnection,ae as SCRCPY_SOCKET_NAME_PREFIX};

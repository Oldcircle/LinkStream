const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-V_WUKhLh.js","assets/stream-BT4ImN5b.js","assets/distribution-vvPj2d0I.js","assets/struct-deserialize-bkGssrR1.js","assets/encoding-D3q_jWej.js","assets/string-Gn2dS4oc.js","assets/uint32-BfumdTHg.js","assets/reverse-D3S_M3ap.js","assets/sticky-event-emitter-B3ySTSV4.js","assets/index-tKmTrm3T.js","assets/3_3_2-DmD8R-J5.js","assets/h265-BZeEvzU-.js","assets/split-string-NR4_hcTk.js","assets/index-CrHIl016.js","assets/index-B7tjb6xv.js","assets/index-C4zOeX9x.js","assets/index-Di93NhIW.js"])))=>i.map(i=>d[i]);
import{_ as a}from"./index-C4zOeX9x.js";async function T(E,o){var w,m,y,_,h,S;let b=null;try{o("Requesting Android device via WebUSB...","info");const e=await a(()=>import("./index-CwCV73Rw.js"),[]),i=await a(()=>import("./index-V_WUKhLh.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8])),n=await a(()=>import("./index-tKmTrm3T.js"),__vite__mapDeps([9,10,3,1,5,6,11,12,8,7,4])),B=await a(()=>import("./index-CrHIl016.js"),__vite__mapDeps([13,10,3,1,5,6,11])),U=await a(()=>import("./index-B7tjb6xv.js"),__vite__mapDeps([14,11,6,8,1,15])),s=await a(()=>import("./index-Di93NhIW.js"),__vite__mapDeps([16,3,1,2,4,12]));if(!navigator.usb)throw new Error("WebUSB not available: use Chrome/Edge over HTTPS or localhost");const A=[{vendorId:6353},{vendorId:1256},{vendorId:4817},{vendorId:10007},{vendorId:10864},{vendorId:8921},{vendorId:11669}];let c;try{typeof((w=e.AdbWebUsbBackend)==null?void 0:w.requestDevice)=="function"?c=await e.AdbWebUsbBackend.requestDevice({filters:A}):c=await navigator.usb.requestDevice({filters:A})}catch(r){if((r==null?void 0:r.name)==="NotFoundError")o("No matching Android device found with filters, showing all devices...","info"),typeof((m=e.AdbWebUsbBackend)==null?void 0:m.requestDevice)=="function"?c=await e.AdbWebUsbBackend.requestDevice({filters:[]}):c=await navigator.usb.requestDevice({filters:[]});else throw r}if(!c)throw new Error("No device selected");let f;if(typeof((y=e.AdbWebUsbBackend)==null?void 0:y.fromDevice)=="function")f=await e.AdbWebUsbBackend.fromDevice(c);else if(typeof e.AdbWebUsbBackend=="function")f=new e.AdbWebUsbBackend(c);else throw new Error("AdbWebUsbBackend not available");const l=await f.connect(),d=new i.Adb(l);typeof d.connect=="function"&&await d.connect(),o("Starting scrcpy server on device...","info");const W=n.AdbScrcpyOptions2_1??n.AdbScrcpyOptions1_24,g=new W({video:{codec:"h264",maxSize:1080,bitRate:8e6,tunnel:"adb"},audio:!1,tunnelForward:!0});let t;try{t=await n.AdbScrcpyClient.start(d,B.DefaultServerPath,g)}catch{const v=new n.AdbScrcpyClient(d,g);try{t={streams:await v.start()}}catch(D){throw o("ADB unauthorized or scrcpy server failed to start. Please accept USB debugging dialog on device and try again.","error"),D}}if((_=t==null?void 0:t.output)!=null&&_.pipeTo&&(s!=null&&s.WritableStream))try{await t.output.pipeTo(new s.WritableStream({write(r){const v=typeof r=="string"?r:(()=>{try{return new TextDecoder().decode(r)}catch{return String(r)}})();o(`scrcpy: ${v}`,"info")}}))}catch{}const u=new U.ScrcpyDecoderWebCodecs({canvas:E}),p=t.videoStream??((h=t.streams)==null?void 0:h.video)??t.streams??t;if(!p)throw new Error("No video stream from scrcpy");o("Decoding H.264 stream via WebCodecs...","info"),typeof u.decode=="function"?u.decode(p):typeof u.render=="function"&&u.render(p),b=async()=>{try{typeof t.close=="function"&&await t.close(),typeof l.close=="function"&&await l.close()}catch{}},o("USB mirror started","success")}catch(e){console.error(e);let i="";(e==null?void 0:e.name)==="SecurityError"&&(i="SecurityError: use HTTPS (GitHub Pages) or localhost, and enable USB debugging."),(e==null?void 0:e.name)==="NotFoundError"&&(i="No device selected or no matching device; ensure phone is connected and unlocked."),(S=e==null?void 0:e.message)!=null&&S.includes("unauthorized")&&(i="Device unauthorized: accept the USB debugging prompt and check Developer options.");const n=JSON.stringify({name:e==null?void 0:e.name,message:e==null?void 0:e.message,stack:e==null?void 0:e.stack},null,2);throw o(`USB mirror failed: ${(e==null?void 0:e.message)||e}${i?" | "+i:""}
${n}`,"error"),e}return{stop:async()=>{b&&await b(),o("USB mirror stopped","info")}}}export{T as startUsbMirror};

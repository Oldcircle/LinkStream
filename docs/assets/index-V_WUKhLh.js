var ts=Object.defineProperty;var dr=s=>{throw TypeError(s)};var rs=(s,e,t)=>e in s?ts(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t;var w=(s,e,t)=>rs(s,typeof e!="symbol"?e+"":e,t),Wt=(s,e,t)=>e.has(s)||dr("Cannot "+t);var i=(s,e,t)=>(Wt(s,e,"read from private field"),t?t.call(s):e.get(s)),c=(s,e,t)=>e.has(s)?dr("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(s):e.set(s,t),l=(s,e,t,r)=>(Wt(s,e,"write to private field"),r?r.call(s,t):e.set(s,t),t),b=(s,e,t)=>(Wt(s,e,"access private method"),t);import{P as k,W as Ft,R as ss,A as Ut,T as ns}from"./stream-BT4ImN5b.js";import{M as St,C as Kt,a as xt,D as is,B as as}from"./distribution-vvPj2d0I.js";import{T as Tt}from"./encoding-D3q_jWej.js";import{u as d,a as os,e as Y,s as sr,d as vt,b as ye,c as nr,g as cs,f as ls,T as hs,h as ds}from"./string-Gn2dS4oc.js";import{s as I,b as Et,B as ir,S as us,P as Ct,a as Tr,C as De,E as be,c as ws,t as fs,d as ys}from"./struct-deserialize-bkGssrR1.js";import{A as Cr,u as bs,N as ps,a as gs,d as ms,s as jt,w as Ss,h as It}from"./reverse-D3S_M3ap.js";import{b as ni,c as ii}from"./reverse-D3S_M3ap.js";import{g as Vt,s as vs}from"./uint32-BfumdTHg.js";import{E as ur,S as wr}from"./sticky-event-emitter-B3ySTSV4.js";class Es{constructor(e=0){w(this,"nextId");w(this,"pendingResolvers",new Map);this.nextId=e}add(){const e=this.nextId++,t=new k;return this.pendingResolvers.set(e,t),[e,t.promise]}getResolver(e){if(!this.pendingResolvers.has(e))return null;const t=this.pendingResolvers.get(e);return this.pendingResolvers.delete(e),t}resolve(e,t){const r=this.getResolver(e);return r!==null?(r.resolve(t),!0):!1}reject(e,t){const r=this.getResolver(e);return r!==null?(r.reject(t),!0):!1}}function As(s,e,t){s[e]=Number(t&0xffn),s[e+1]=Number(t>>8n&0xffn),s[e+2]=Number(t>>16n&0xffn),s[e+3]=Number(t>>24n&0xffn),s[e+4]=Number(t>>32n&0xffn),s[e+5]=Number(t>>40n&0xffn),s[e+6]=Number(t>>48n&0xffn),s[e+7]=Number(t>>56n&0xffn)}function ks(s,e,t){s[e]=Number(t>>56n&0xffn),s[e+1]=Number(t>>48n&0xffn),s[e+2]=Number(t>>40n&0xffn),s[e+3]=Number(t>>32n&0xffn),s[e+4]=Number(t>>24n&0xffn),s[e+5]=Number(t>>16n&0xffn),s[e+6]=Number(t>>8n&0xffn),s[e+7]=Number(t&0xffn)}const xs=I({version:d},{littleEndian:!0}),Ts=I({bpp:d,size:d,width:d,height:d,red_offset:d,red_length:d,blue_offset:d,blue_length:d,green_offset:d,green_length:d,alpha_offset:d,alpha_length:d,data:Et("size")},{littleEndian:!0}),Cs=I({bpp:d,colorSpace:d,size:d,width:d,height:d,red_offset:d,red_length:d,blue_offset:d,blue_length:d,green_offset:d,green_length:d,alpha_offset:d,alpha_length:d,data:Et("size")},{littleEndian:!0});class Ir extends Error{constructor(e,t){super(e,t)}}class Is extends Ir{constructor(e){super(`Unsupported FrameBuffer version ${e}`)}}class Ps extends Ir{constructor(){super("FrameBuffer is disabled by current app")}}async function Ds(s){const e=await s.createSocket("framebuffer:"),t=new ir(e.readable);let r;try{({version:r}=await xs.deserialize(t))}catch(n){throw n instanceof us?new Ps:n}switch(r){case 1:return await Ts.deserialize(t);case 2:return await Cs.deserialize(t);default:throw new Is(r)}}class _s extends Cr{reboot(e=""){return this.adb.createSocketAndWait(`reboot:${e}`)}bootloader(){return this.reboot("bootloader")}fastboot(){return this.reboot("fastboot")}recovery(){return this.reboot("recovery")}sideload(){return this.reboot("sideload")}qualcommEdlMode(){return this.reboot("edl")}powerOff(){return this.adb.subprocess.noneProtocol.spawnWaitText(["reboot","-p"])}powerButton(e=!1){const t=["input","keyevent"];return e&&t.push("--longpress"),t.push("POWER"),this.adb.subprocess.noneProtocol.spawnWaitText(t)}samsungOdin(){return this.reboot("download")}}function Qn(s){if(s.buffer instanceof ArrayBuffer)return s;const e=new Uint8Array(s.length);return e.set(s),e}var J,V;class Pr{constructor(e=!1){c(this,J);c(this,V,[]);l(this,J,e)}wait(){if(!i(this,J)&&(l(this,J,!0),i(this,V).length===0))return Promise.resolve();const e=new k;return i(this,V).push(e),e.promise}notifyOne(){i(this,V).length!==0?i(this,V).pop().resolve():l(this,J,!1)}dispose(){for(const e of i(this,V))e.reject(new Error("The AutoResetEvent has been disposed"));i(this,V).length=0}}J=new WeakMap,V=new WeakMap;const[U,g,pe]=(()=>{const s=[],e=[];function r(n,a){const o=n.charCodeAt(0),h=a.charCodeAt(0);for(let u=o;u<=h;u+=1)s[u]=e.length,e.push(u)}return r("A","Z"),r("a","z"),r("0","9"),r("+","+"),r("/","/"),[s,e,61]})();function Dr(s){const e=s%3,t=e!==0?3-e:0;return[(s+t)/3*4,t]}function Rs(s,e){const[t,r]=Dr(s.length);if(e){if(e.length<t)throw new TypeError("output buffer is too small");if(e=e.subarray(0,t),s.buffer!==e.buffer)$t(s,e,r);else if(e.byteOffset+e.length-(r+1)<=s.byteOffset+s.length)$t(s,e,r);else if(e.byteOffset>=s.byteOffset-1)Ls(s,e,r);else throw new TypeError("input and output cannot overlap");return t}else return e=new Uint8Array(t),$t(s,e,r),e}function $t(s,e,t){let r=0,n=0;for(;r<s.length-2;){const a=s[r];r+=1;const o=s[r];r+=1;const h=s[r];r+=1,e[n]=g[a>>2],n+=1,e[n]=g[(a&3)<<4|o>>4],n+=1,e[n]=g[(o&15)<<2|h>>6],n+=1,e[n]=g[h&63],n+=1}if(t===2){const a=s[r];r+=1,e[n]=g[a>>2],n+=1,e[n]=g[(a&3)<<4],n+=1,e[n]=pe,n+=1,e[n]=pe}else if(t===1){const a=s[r];r+=1;const o=s[r];r+=1,e[n]=g[a>>2],n+=1,e[n]=g[(a&3)<<4|o>>4],n+=1,e[n]=g[(o&15)<<2],n+=1,e[n]=pe}}function Ls(s,e,t){let r=s.length-1,n=e.length-1;if(t===2){const a=s[r];r-=1,e[n]=pe,n-=1,e[n]=pe,n-=1,e[n]=g[(a&3)<<4],n-=1,e[n]=g[a>>2],n-=1}else if(t===1){const a=s[r];r-=1;const o=s[r];r-=1,e[n]=pe,n-=1,e[n]=g[(a&15)<<2],n-=1,e[n]=g[(o&3)<<4|a>>4],n-=1,e[n]=g[o>>2],n-=1}for(;r>=0;){const a=s[r];r-=1;const o=s[r];r-=1;const h=s[r];r-=1,e[n]=g[a&63],n-=1,e[n]=g[(o&15)<<2|a>>6],n-=1,e[n]=g[(h&3)<<4|o>>4],n-=1,e[n]=g[h>>2],n-=1}}function Jn(s){let e;s[s.length-2]==="="?e=2:s[s.length-1]==="="?e=1:e=0;const t=new Uint8Array(s.length/4*3-e);let r=0,n=0;for(;r<s.length-(e!==0?4:0);){const a=U[s.charCodeAt(r)];r+=1;const o=U[s.charCodeAt(r)];r+=1;const h=U[s.charCodeAt(r)];r+=1;const u=U[s.charCodeAt(r)];r+=1,t[n]=a<<2|(o&48)>>4,n+=1,t[n]=(o&15)<<4|(h&60)>>2,n+=1,t[n]=(h&3)<<6|u,n+=1}if(e===1){const a=U[s.charCodeAt(r)];r+=1;const o=U[s.charCodeAt(r)];r+=1;const h=U[s.charCodeAt(r)];t[n]=a<<2|(o&48)>>4,n+=1,t[n]=(o&15)<<4|(h&60)>>2}else if(e===2){const a=U[s.charCodeAt(r)];r+=1;const o=U[s.charCodeAt(r)];t[n]=a<<2|(o&48)>>4}return t}const{setInterval:Ns,clearInterval:Os}=globalThis;var ee;class zs{constructor(e){c(this,ee);e!=null&&e.unref||this.ref()}ref(){l(this,ee,Ns(()=>{},60*1e3))}unref(){i(this,ee)&&(Os(i(this,ee)),l(this,ee,void 0))}}ee=new WeakMap;var N,ge;class Fs{constructor(e,t){c(this,N);c(this,ge);if(l(this,N,e),t){const r=new k;i(this,N).closed.then(()=>r.resolve(void 0),n=>r.reject(n)),t.addEventListener("abort",()=>{r.reject(t.reason),i(this,N).close()}),l(this,ge,r.promise)}else l(this,ge,i(this,N).closed)}get stdin(){return i(this,N).writable}get output(){return i(this,N).readable}get exited(){return i(this,ge)}kill(){return i(this,N).close()}}N=new WeakMap,ge=new WeakMap;var $,me,_e;class Us{constructor(e){c(this,$);c(this,me);c(this,_e);l(this,$,e),l(this,me,i(this,$).writable.getWriter()),l(this,_e,new St({write:t=>i(this,me).write(t)}))}get input(){return i(this,_e)}get output(){return i(this,$).readable}get exited(){return i(this,$).closed}sigint(){return i(this,me).write(new Uint8Array([3]))}kill(){return i(this,$).close()}}$=new WeakMap,me=new WeakMap,_e=new WeakMap;function qt(s){let e="";e+="'";let t=0;for(;;){const r=s.indexOf("'",t);if(r===-1){e+=s.substring(t);break}e+=s.substring(t,r),e+=String.raw`'\''`,t=r+1}return e+="'",e}function _r(s){const e=[];let t,r=!1,n=0;for(let a=0,o=s.length;a<o;a+=1){if(r){r=!1;continue}const h=s.charAt(a);switch(h){case" ":!t&&a!==n&&(e.push(s.substring(n,a)),n=a+1);break;case"'":case'"':t?h===t&&(t=void 0):t=h;break;case"\\":r=!0;break}}return n<s.length&&e.push(s.substring(n)),e}var Re;class Vs{constructor(e){c(this,Re);l(this,Re,e)}spawn(e,t){return t==null||t.throwIfAborted(),typeof e=="string"&&(e=_r(e)),i(this,Re).call(this,e,t)}async spawnWait(e){return await(await this.spawn(e)).output.pipeThrough(new Kt)}async spawnWaitText(e){return await(await this.spawn(e)).output.pipeThrough(new Tt).pipeThrough(new xt)}}Re=new WeakMap;var te;class Bs extends Vs{constructor(t){super(async(r,n)=>{const a=await i(this,te).createSocket(`exec:${r.join(" ")}`);if(n!=null&&n.aborted)throw await a.close(),n.reason;return new Fs(a,n)});c(this,te);l(this,te,t)}get adb(){return i(this,te)}async pty(t){return t===void 0?t="":Array.isArray(t)&&(t=t.join(" ")),new Us(await i(this,te).createSocket(`shell:${t}`))}}te=new WeakMap;const y={ShellV2:"shell_v2",Cmd:"cmd",StatV2:"stat_v2",ListV2:"ls_v2",FixedPushMkdir:"fixed_push_mkdir",Abb:"abb",AbbExec:"abb_exec",SendReceiveV2:"sendrecv_v2",DelayedAck:"delayed_ack"},H={Stdin:0,Stdout:1,Stderr:2,Exit:3,CloseStdin:4,WindowSizeChange:5},Pe=I({id:os(),data:Et(d)},{littleEndian:!0});var re,Le,Ne,Oe,ze,Fe;class Ws{constructor(e,t){c(this,re);c(this,Le);c(this,Ne);c(this,Oe);c(this,ze);c(this,Fe);l(this,re,e);let r,n;l(this,Oe,new Ct(o=>{r=o})),l(this,ze,new Ct(o=>{n=o}));const a=new k;l(this,Fe,a.promise),e.readable.pipeThrough(new Tr(Pe)).pipeTo(new Ft({write:async o=>{switch(o.id){case H.Exit:a.resolve(o.data[0]);break;case H.Stdout:await r.enqueue(o.data);break;case H.Stderr:await n.enqueue(o.data);break}}})).then(()=>{r.close(),n.close(),a.reject(new Error("Socket ended without exit message"))},o=>{r.error(o),n.error(o),a.reject(o)}),t&&t.addEventListener("abort",()=>{a.reject(t.reason),i(this,re).close()}),l(this,Le,i(this,re).writable.getWriter()),l(this,Ne,new St({write:async o=>{await i(this,Le).write(Pe.serialize({id:H.Stdin,data:o}))}}))}get stdin(){return i(this,Ne)}get stdout(){return i(this,Oe)}get stderr(){return i(this,ze)}get exited(){return i(this,Fe)}kill(){return i(this,re).close()}}re=new WeakMap,Le=new WeakMap,Ne=new WeakMap,Oe=new WeakMap,ze=new WeakMap,Fe=new WeakMap;var Se,ve,Ue,Ve,se,Be,Gt;class $s{constructor(e){c(this,Be);c(this,Se);c(this,ve);c(this,Ue);c(this,Ve);c(this,se,new k);l(this,Se,e);let t;l(this,Ve,new Ct(r=>{t=r})),e.readable.pipeThrough(new Tr(Pe)).pipeTo(new Ft({write:async r=>{switch(r.id){case H.Exit:i(this,se).resolve(r.data[0]);break;case H.Stdout:await t.enqueue(r.data);break}}})).then(()=>{t.close(),i(this,se).reject(new Error("Socket ended without exit message"))},r=>{t.error(r),i(this,se).reject(r)}),l(this,ve,i(this,Se).writable.getWriter()),l(this,Ue,new St({write:r=>b(this,Be,Gt).call(this,r)}))}get input(){return i(this,Ue)}get output(){return i(this,Ve)}get exited(){return i(this,se).promise}async resize(e,t){await i(this,ve).write(Pe.serialize({id:H.WindowSizeChange,data:Y(`${e}x${t},0x0\0`)}))}sigint(){return b(this,Be,Gt).call(this,new Uint8Array([3]))}kill(){return i(this,Se).close()}}Se=new WeakMap,ve=new WeakMap,Ue=new WeakMap,Ve=new WeakMap,se=new WeakMap,Be=new WeakSet,Gt=function(e){return i(this,ve).write(Pe.serialize({id:H.Stdin,data:e}))};var We;class Ms{constructor(e){c(this,We);l(this,We,e)}spawn(e,t){return t==null||t.throwIfAborted(),typeof e=="string"&&(e=_r(e)),i(this,We).call(this,e,t)}async spawnWait(e){const t=await this.spawn(e),[r,n,a]=await Promise.all([t.stdout.pipeThrough(new Kt),t.stderr.pipeThrough(new Kt),t.exited]);return{stdout:r,stderr:n,exitCode:a}}async spawnWaitText(e){const t=await this.spawn(e),[r,n,a]=await Promise.all([t.stdout.pipeThrough(new Tt).pipeThrough(new xt),t.stderr.pipeThrough(new Tt).pipeThrough(new xt),t.exited]);return{stdout:r,stderr:n,exitCode:a}}}We=new WeakMap;var M;class Ks extends Ms{constructor(t){super(async(r,n)=>{const a=await i(this,M).createSocket(`shell,v2,raw:${r.join(" ")}`);if(n!=null&&n.aborted)throw await a.close(),n.reason;return new Ws(a,n)});c(this,M);l(this,M,t)}get adb(){return i(this,M)}get isSupported(){return i(this,M).canUseFeature(y.ShellV2)}async pty(t){let r="shell,v2,pty";return t!=null&&t.terminalType&&(r+=",TERM="+t.terminalType),r+=":",t&&(typeof t.command=="string"?r+=t.command:Array.isArray(t.command)&&(r+=t.command.join(" "))),new $s(await i(this,M).createSocket(r))}}M=new WeakMap;var $e,Me,Ke;class js{constructor(e){c(this,$e);c(this,Me);c(this,Ke);l(this,$e,e),l(this,Me,new Bs(e)),e.canUseFeature(y.ShellV2)&&l(this,Ke,new Ks(e))}get adb(){return i(this,$e)}get noneProtocol(){return i(this,Me)}get shellProtocol(){return i(this,Ke)}}$e=new WeakMap,Me=new WeakMap,Ke=new WeakMap;function qs(s){const e=new Uint8Array(s.length);for(let t=0;t<s.length;t+=1)e[t]=s.charCodeAt(t);return e}function p(s){const e=qs(s);return Vt(e,0)}const C={Entry:p("DENT"),Entry2:p("DNT2"),Lstat:p("STAT"),Stat:p("STA2"),Lstat2:p("LST2"),Done:p("DONE"),Data:p("DATA"),Ok:p("OKAY"),Fail:p("FAIL")};class Gs extends Error{}const Rr=I({message:sr(d)},{littleEndian:!0,postDeserialize(s){throw new Gs(s.message)}});async function Pt(s,e,t){typeof e=="string"&&(e=p(e));const r=await s.readExactly(4);switch(Vt(r,0)){case C.Fail:throw await Rr.deserialize(s),new Error("Unreachable");case e:return await t.deserialize(s);default:throw new Error(`Expected '${e}', but got '${vt(r)}'`)}}async function*Dt(s,e,t){for(typeof e=="string"&&(e=p(e));;){const r=await s.readExactly(4);switch(Vt(r,0)){case C.Fail:await Rr.deserialize(s),bs();case C.Done:await s.readExactly(t.size);return;case e:yield await t.deserialize(s);break;default:throw new Error(`Expected '${e}' or '${C.Done}', but got '${vt(r)}'`)}}}const R={List:p("LIST"),ListV2:p("LIS2"),Send:p("SEND"),SendV2:p("SND2"),Lstat:p("STAT"),Stat:p("STA2"),LstatV2:p("LST2"),Data:p("DATA"),Done:p("DONE"),Receive:p("RECV")},fr=I({id:d,arg:d},{littleEndian:!0});async function z(s,e,t){if(typeof e=="string"&&(e=p(e)),typeof t=="number"){await s.write(fr.serialize({id:e,arg:t}));return}typeof t=="string"&&(t=Y(t)),await s.write(fr.serialize({id:e,arg:t.length})),await s.write(t)}const Lr={Directory:4,File:8,Link:10},Nr=I({mode:d,size:d,mtime:d},{littleEndian:!0,extra:{get type(){return this.mode>>12},get permission(){return this.mode&4095}},postDeserialize(s){if(s.mode===0&&s.size===0&&s.mtime===0)throw new Error("lstat error");return s}}),Or={SUCCESS:0,EACCES:13,EEXIST:17,EFAULT:14,EFBIG:27,EINTR:4,EINVAL:22,EIO:5,EISDIR:21,ELOOP:40,EMFILE:24,ENAMETOOLONG:36,ENFILE:23,ENOENT:2,ENOMEM:12,ENOSPC:28,ENOTDIR:20,EOVERFLOW:75,EPERM:1,EROFS:30,ETXTBSY:26},Hs=Object.fromEntries(Object.entries(Or).map(([s,e])=>[e,s])),ar=I({error:d(),dev:ye,ino:ye,mode:d,nlink:d,uid:d,gid:d,size:ye,atime:ye,mtime:ye,ctime:ye},{littleEndian:!0,extra:{get type(){return this.mode>>12},get permission(){return this.mode&4095}},postDeserialize(s){if(s.error)throw new Error(Hs[s.error]);return s}});async function Ys(s,e,t){const r=await s.lock();try{if(t)return await z(r,R.LstatV2,e),await Pt(r,C.Lstat2,ar);{await z(r,R.Lstat,e);const n=await Pt(r,C.Lstat,Nr);return{mode:n.mode,size:BigInt(n.size),mtime:BigInt(n.mtime),get type(){return n.type},get permission(){return n.permission}}}}finally{r.release()}}async function Zs(s,e){const t=await s.lock();try{return await z(t,R.Stat,e),await Pt(t,C.Stat,ar)}finally{t.release()}}const Xs=nr(Nr,{name:sr(d)}),Qs=nr(ar,{name:sr(d)});async function*Js(s,e){const t=await s.lock();try{await z(t,R.ListV2,e);for await(const r of Dt(t,C.Entry2,Qs))r.error===Or.SUCCESS&&(yield r)}finally{t.release()}}async function*en(s,e){const t=await s.lock();try{await z(t,R.List,e);for await(const r of Dt(t,C.Entry,Xs))yield r}finally{t.release()}}async function*tn(s,e,t){if(t)yield*Js(s,e);else for await(const r of en(s,e))yield{mode:r.mode,size:BigInt(r.size),mtime:BigInt(r.mtime),get type(){return r.type},get permission(){return r.permission},name:r.name}}const yr=I({data:Et(d)},{littleEndian:!0});async function*rn(s,e){const t=await s.lock();let r=!1;try{await z(t,R.Receive,e);for await(const n of Dt(t,C.Data,yr))yield n.data;r=!0}catch(n){throw r=!0,n}finally{if(!r)for await(const n of Dt(t,C.Data,yr));t.release()}}function sn(s,e){return ss.from(rn(s,e))}const zr=64*1024,nn=I({unused:d},{littleEndian:!0});async function Fr(s,e,t,r){const n=new Ut;e.pipeThrough(new is(t,!0)).pipeTo(new St({write(a){return z(s,R.Data,a)}}),{signal:n.signal}).then(async()=>{await z(s,R.Done,r),await s.flush()},ps),await Pt(s,C.Ok,nn).catch(a=>{throw n.abort(),a})}async function an({socket:s,filename:e,file:t,type:r=Lr.File,permission:n=438,mtime:a=Date.now()/1e3|0,packetSize:o=zr}){const h=await s.lock();try{const u=r<<12|n,f=`${e},${u.toString()}`;await z(h,R.Send,f),await Fr(h,t,o,a)}finally{h.release()}}const br={None:0,Brotli:1,Lz4:2,Zstd:4,DryRun:2147483648},on=I({id:d,mode:d,flags:d()},{littleEndian:!0});async function cn({socket:s,filename:e,file:t,type:r=Lr.File,permission:n=438,mtime:a=Date.now()/1e3|0,packetSize:o=zr,dryRun:h=!1}){const u=await s.lock();try{await z(u,R.SendV2,e);const f=r<<12|n;let m=br.None;h&&(m|=br.DryRun),await u.write(on.serialize({id:R.SendV2,mode:f,flags:m})),await Fr(u,t,o,a)}finally{u.release()}}function ln(s){if(s.v2)return cn(s);if(s.dryRun)throw new Error("dryRun is not supported in v1");return an(s)}var je,ne,qe,ie,ae,Ge,Ht;class hn{constructor(e,t,r,n){c(this,Ge);c(this,je);c(this,ne);c(this,qe);c(this,ie,new Pr);c(this,ae);l(this,je,e),l(this,ne,t),l(this,qe,n),l(this,ae,new as(r))}get position(){return i(this,ne).position}async flush(){try{await i(this,ie).wait();const e=i(this,ae).flush();e&&await b(this,Ge,Ht).call(this,e)}finally{i(this,ie).notifyOne()}}async write(e){try{await i(this,ie).wait();for(const t of i(this,ae).push(e))await b(this,Ge,Ht).call(this,t)}finally{i(this,ie).notifyOne()}}async readExactly(e){return await this.flush(),await i(this,ne).readExactly(e)}release(){i(this,ae).flush(),i(this,qe).notifyOne()}async close(){await i(this,ne).cancel()}}je=new WeakMap,ne=new WeakMap,qe=new WeakMap,ie=new WeakMap,ae=new WeakMap,Ge=new WeakSet,Ht=function(e){return De.WritableStream.write(i(this,je),e)};var He,Ye,Ee;class dn{constructor(e,t){c(this,He,new Pr);c(this,Ye);c(this,Ee);l(this,Ye,e),l(this,Ee,new hn(e.writable.getWriter(),new ir(e.readable),t,i(this,He)))}async lock(){return await i(this,He).wait(),i(this,Ee)}async close(){await i(this,Ee).close(),await i(this,Ye).close()}}He=new WeakMap,Ye=new WeakMap,Ee=new WeakMap;function un(s){const e=s.lastIndexOf("/");if(e===-1)throw new Error("Invalid path");return e===0?"/":s.substring(0,e)}var oe,Ze,Xe,Qe,Je;class wn{constructor(e,t){w(this,"_adb");w(this,"_socket");c(this,oe);c(this,Ze);c(this,Xe);c(this,Qe);c(this,Je);this._adb=e,this._socket=new dn(t,e.maxPayloadSize),l(this,oe,e.canUseFeature(y.StatV2)),l(this,Ze,e.canUseFeature(y.ListV2)),l(this,Xe,e.canUseFeature(y.FixedPushMkdir)),l(this,Qe,e.canUseFeature(y.SendReceiveV2)),l(this,Je,this._adb.canUseFeature(y.ShellV2)&&!this.fixedPushMkdir)}get supportsStat(){return i(this,oe)}get supportsListV2(){return i(this,Ze)}get fixedPushMkdir(){return i(this,Xe)}get supportsSendReceiveV2(){return i(this,Qe)}get needPushMkdirWorkaround(){return i(this,Je)}async lstat(e){return await Ys(this._socket,e,i(this,oe))}async stat(e){if(!i(this,oe))throw new Error("Not supported");return await Zs(this._socket,e)}async isDirectory(e){try{return await this.lstat(e+"/"),!0}catch{return!1}}opendir(e){return tn(this._socket,e,this.supportsListV2)}async readdir(e){const t=[];for await(const r of this.opendir(e))t.push(r);return t}read(e){return sn(this._socket,e)}async write(e){this.needPushMkdirWorkaround&&await this._adb.subprocess.noneProtocol.spawnWait(["mkdir","-p",qt(un(e.filename))]),await ln({v2:this.supportsSendReceiveV2,socket:this._socket,...e})}lockSocket(){return this._socket.lock()}dispose(){return this._socket.close()}}oe=new WeakMap,Ze=new WeakMap,Xe=new WeakMap,Qe=new WeakMap,Je=new WeakMap;function pr(s){if(!(!s||s==="0"))return Number.parseInt(s,10)}class fn extends Cr{async getListenAddresses(){const e=await this.adb.getProp("service.adb.listen_addrs"),t=await this.adb.getProp("service.adb.tcp.port"),r=await this.adb.getProp("persist.adb.tcp.port");return{serviceListenAddresses:e!=""?e.split(","):[],servicePort:pr(t),persistPort:pr(r)}}async setPort(e){if(e<=0)throw new TypeError(`Invalid port ${e}`);const t=await this.adb.createSocketAndWait(`tcpip:${e}`);if(t!==`restarting in TCP mode port: ${e}
`)throw new Error(t);return t}async disable(){const e=await this.adb.createSocketAndWait("usb:");if(e!==`restarting in USB mode
`)throw new Error(e);return e}}var x;class yn{constructor(e){c(this,x);w(this,"subprocess");w(this,"power");w(this,"reverse");w(this,"tcpip");l(this,x,e),this.subprocess=new js(this),this.power=new _s(this),this.reverse=new gs(this),this.tcpip=new fn(this)}get transport(){return i(this,x)}get serial(){return i(this,x).serial}get maxPayloadSize(){return i(this,x).maxPayloadSize}get banner(){return i(this,x).banner}get disconnected(){return i(this,x).disconnected}get clientFeatures(){return i(this,x).clientFeatures}get deviceFeatures(){return this.banner.features}canUseFeature(e){return this.clientFeatures.includes(e)&&this.deviceFeatures.includes(e)}async createSocket(e){return i(this,x).connect(e)}async createSocketAndWait(e){return await(await this.createSocket(e)).readable.pipeThrough(new Tt).pipeThrough(new xt)}getProp(e){return this.subprocess.noneProtocol.spawnWaitText(["getprop",e]).then(t=>t.trim())}rm(e,t){const r=["rm"];if(t!=null&&t.recursive&&r.push("-r"),t!=null&&t.force&&r.push("-f"),Array.isArray(e))for(const n of e)r.push(qt(n));else r.push(qt(e));return r.push("</dev/null"),this.subprocess.noneProtocol.spawnWaitText(r)}async sync(){const e=await this.createSocket("sync:");return new wn(this,e)}async framebuffer(){return Ds(this)}async close(){await i(this,x).close()}}x=new WeakMap;const At={Product:"ro.product.name",Model:"ro.product.model",Device:"ro.product.device",Features:"features"};var et,tt,rt,st;const or=class or{constructor(e,t,r,n){c(this,et);c(this,tt);c(this,rt);c(this,st,[]);l(this,et,e),l(this,tt,t),l(this,rt,r),l(this,st,n)}static parse(e){let t,r,n,a=[];const o=e.split("::");if(o.length>1){const h=o[1];for(const u of h.split(";")){if(!u)continue;const f=u.split("=");if(f.length!==2)continue;const[m,A]=f;switch(m){case At.Product:t=A;break;case At.Model:r=A;break;case At.Device:n=A;break;case At.Features:a=A.split(",");break}}}return new or(t,r,n,a)}get product(){return i(this,et)}get model(){return i(this,tt)}get device(){return i(this,rt)}get features(){return i(this,st)}};et=new WeakMap,tt=new WeakMap,rt=new WeakMap,st=new WeakMap;let _t=or;function Yt(s,e,t){let r=0n;for(let n=e;n<e+t;n+=8){r<<=64n;const a=cs(s,n);r|=a}return r}function Zt(s,e,t,r,n){if(n)for(;r>0n;)As(s,e,r),e+=8,r>>=64n;else{let a=e+t-8;for(;r>0n;)ks(s,a,r),a-=8,r>>=64n}}const bn=38,pn=2048/8,gn=303,mn=2048/8;function Ur(s){const e=Yt(s,bn,pn),t=Yt(s,gn,mn);return[e,t]}function gr(s,e){const t=s%e;return t>0?t:t+(e>0?e:-e)}function Sn(s,e){if(s=gr(s,e),!s||e<2)return NaN;const t=[];let r=e;for(;r;)[s,r]=[r,s%r],t.push({a:s,b:r});if(s!==1)return NaN;let n=1,a=0;for(let o=t.length-2;o>=0;o-=1)[n,a]=[a,n-a*Math.floor(t[o].a/t[o].b)];return gr(a,e)}const Q=2048/8,vn=Q/4;function Vr(){return 8+Q+Q+4}function En(s,e){let t;const r=Vr();if(!e)e=new Uint8Array(r),t="Uint8Array";else{if(e.length<r)throw new TypeError("output buffer is too small");t="number"}const n=new DataView(e.buffer,e.byteOffset,e.length);let a=0;n.setUint32(a,vn,!0),a+=4;const[o]=Ur(s),h=-Sn(Number(o%2n**32n),2**32);n.setInt32(a,h,!0),a+=4,Zt(e,a,Q,o,!0),a+=Q;const u=2n**4096n%o;return Zt(e,a,Q,u,!0),a+=Q,n.setUint32(a,65537,!0),a+=4,t==="Uint8Array"?e:r}function An(s,e,t){if(t===1n)return 0n;let r=1n;for(s=s%t;e>0n;)BigInt.asUintN(1,e)===1n&&(r=r*s%t),s=s*s%t,e>>=1n;return r}const mr=20,Sr=48,kn=4,xn=5,Tn=6,Mt=new Uint8Array([Sr,13+mr,Sr,9,Tn,5,43,14,3,2,26,xn,0,kn,mr]);function Cn(s,e){const[t,r]=Ur(s),n=new Uint8Array(256);let a=0;n[a]=0,a+=1,n[a]=1,a+=1;const o=n.length-Mt.length-e.length-1;for(;a<o;)n[a]=255,a+=1;n[a]=0,a+=1,n.set(Mt,a),a+=Mt.length,n.set(e,a);const h=An(Yt(n,0,n.length),r,t);return Zt(n,0,n.length,h,!1),n}const v={Auth:1213486401,Close:1163086915,Connect:1314410051,Okay:1497451343,Open:1313165391,Write:1163154007},Xt=I({command:d,arg0:d,arg1:d,payloadLength:d,checksum:d,magic:ls},{littleEndian:!0}),ei=nr(Xt,{payload:Et("payloadLength")});function Br(s){return s.reduce((e,t)=>e+t,0)}class ti extends ns{constructor(){const e=new Uint8Array(Xt.size);super({transform:async(t,r)=>{await t.tryConsume(async n=>{const a=n;a.payloadLength=a.payload.length,Xt.serialize(a,e),await De.ReadableStream.enqueue(r,e),a.payloadLength&&await De.ReadableStream.enqueue(r,a.payload)})}})}}const Rt={Token:1,Signature:2,PublicKey:3},In=async function*(s,e){for await(const t of s.iterateKeys()){const r=await e();if(r.arg0!==Rt.Token)return;const n=Cn(t.buffer,r.payload);yield{command:v.Auth,arg0:Rt.Signature,arg1:0,payload:n}}},Pn=async function*(s,e){var u;if((await e()).arg0!==Rt.Token)return;let r;for await(const f of s.iterateKeys()){r=f;break}r||(r=await s.generateKey());const n=Vr(),[a]=Dr(n),o=(u=r.name)!=null&&u.length?Y(r.name):be,h=new Uint8Array(a+(o.length?o.length+1:0)+1);En(r.buffer,h),Rs(h.subarray(0,n),h),o.length&&(h[a]=32,h.set(o,a+1)),yield{command:v.Auth,arg0:Rt.PublicKey,arg1:0,payload:h}},Dn=[In,Pn];var nt,Ae,ce,Lt,Nt,Wr;class _n{constructor(e,t){c(this,Nt);w(this,"authenticators");c(this,nt);c(this,Ae,new k);c(this,ce);c(this,Lt,()=>i(this,Ae).promise);this.authenticators=e,l(this,nt,t)}async process(e){i(this,ce)||l(this,ce,b(this,Nt,Wr).call(this)),i(this,Ae).resolve(e);const t=await i(this,ce).next();if(t.done)throw new Error("No authenticator can handle the request");return t.value}dispose(){var e,t;(t=(e=i(this,ce))==null?void 0:e.return)==null||t.call(e)}}nt=new WeakMap,Ae=new WeakMap,ce=new WeakMap,Lt=new WeakMap,Nt=new WeakSet,Wr=async function*(){for(const e of this.authenticators)for await(const t of e(i(this,nt),i(this,Lt)))l(this,Ae,new k),yield t};var le,it,ke,at,ot,ct,lt,he,B,Ot,$r;class vr{constructor(e){c(this,Ot);c(this,le);w(this,"localId");w(this,"remoteId");w(this,"localCreated");w(this,"service");c(this,it);c(this,ke);c(this,at);w(this,"writable");c(this,ot,!1);c(this,ct,new k);c(this,lt);c(this,he);c(this,B,0);l(this,le,e.dispatcher),this.localId=e.localId,this.remoteId=e.remoteId,this.localCreated=e.localCreated,this.service=e.service,l(this,it,new Ct(t=>{l(this,ke,t)})),this.writable=new St({start:t=>{l(this,at,t),t.signal.addEventListener("abort",()=>{var r;(r=i(this,he))==null||r.reject(t.signal.reason)})},write:async t=>{const r=t.length,n=i(this,le).options.maxPayloadSize;for(let a=0,o=n;a<r;a=o,o+=n){const h=t.subarray(a,o);await b(this,Ot,$r).call(this,h)}}}),l(this,lt,new Rn(this)),l(this,B,e.availableWriteBytes)}get readable(){return i(this,it)}get closed(){return i(this,ct).promise}get socket(){return i(this,lt)}async enqueue(e){await i(this,ke).enqueue(e)}ack(e){var t;l(this,B,i(this,B)+e),(t=i(this,he))==null||t.resolve()}async close(){var e;if(!i(this,ot)){l(this,ot,!0),(e=i(this,he))==null||e.reject(new Error("Socket closed"));try{i(this,at).error(new Error("Socket closed"))}catch{}await i(this,le).sendPacket(v.Close,this.localId,this.remoteId,be)}}dispose(){i(this,ke).close(),i(this,ct).resolve(void 0)}}le=new WeakMap,it=new WeakMap,ke=new WeakMap,at=new WeakMap,ot=new WeakMap,ct=new WeakMap,lt=new WeakMap,he=new WeakMap,B=new WeakMap,Ot=new WeakSet,$r=async function(e){const t=e.length;for(;i(this,B)<t;){const r=new k;l(this,he,r),await r.promise}i(this,B)===1/0?l(this,B,-1):l(this,B,i(this,B)-t),await i(this,le).sendPacket(v.Write,this.localId,this.remoteId,e)};var T;class Rn{constructor(e){c(this,T);l(this,T,e)}get localId(){return i(this,T).localId}get remoteId(){return i(this,T).remoteId}get localCreated(){return i(this,T).localCreated}get service(){return i(this,T).service}get readable(){return i(this,T).readable}get writable(){return i(this,T).writable}get closed(){return i(this,T).closed}close(){return i(this,T).close()}}T=new WeakMap;var K,P,de,ht,xe,ue,dt,E,Mr,Kr,Qt,jr,qr,Jt;class Ln{constructor(e,t){c(this,E);c(this,K,new Es(1));c(this,P,new Map);c(this,de);w(this,"options");c(this,ht,!1);c(this,xe,new k);c(this,ue,new Map);c(this,dt,new Ut);this.options=t,this.options.initialDelayedAckBytes<0&&(this.options.initialDelayedAckBytes=0),e.readable.pipeTo(new Ft({write:async r=>{switch(r.command){case v.Close:await b(this,E,Mr).call(this,r);break;case v.Okay:b(this,E,Kr).call(this,r);break;case v.Open:await b(this,E,jr).call(this,r);break;case v.Write:await b(this,E,qr).call(this,r);break;default:throw new Error(`Unknown command: ${r.command.toString(16)}`)}}}),{preventCancel:t.preserveConnection??!1,signal:i(this,dt).signal}).then(()=>{b(this,E,Jt).call(this)},r=>{i(this,ht)||i(this,xe).reject(r),b(this,E,Jt).call(this)}),l(this,de,e.writable.getWriter())}get disconnected(){return i(this,xe).promise}async createSocket(e){this.options.appendNullToServiceString&&(e+="\0");const[t,r]=i(this,K).add();await this.sendPacket(v.Open,t,this.options.initialDelayedAckBytes,e);const{remoteId:n,availableWriteBytes:a}=await r,o=new vr({dispatcher:this,localId:t,remoteId:n,localCreated:!0,service:e,availableWriteBytes:a});return i(this,P).set(t,o),o.socket}addReverseTunnel(e,t){i(this,ue).set(e,t)}removeReverseTunnel(e){i(this,ue).delete(e)}clearReverseTunnels(){i(this,ue).clear()}async sendPacket(e,t,r,n){if(typeof n=="string"&&(n=Y(n)),n.length>this.options.maxPayloadSize)throw new TypeError("payload too large");await De.WritableStream.write(i(this,de),{command:e,arg0:t,arg1:r,payload:n,checksum:this.options.calculateChecksum?Br(n):0,magic:e^4294967295})}async close(){await Promise.all(Array.from(i(this,P).values(),e=>e.close())),l(this,ht,!0),i(this,dt).abort(),this.options.preserveConnection?i(this,de).releaseLock():await i(this,de).close()}}K=new WeakMap,P=new WeakMap,de=new WeakMap,ht=new WeakMap,xe=new WeakMap,ue=new WeakMap,dt=new WeakMap,E=new WeakSet,Mr=async function(e){if(e.arg0===0&&i(this,K).reject(e.arg1,new Error("Socket open failed")))return;const t=i(this,P).get(e.arg1);if(t){await t.close(),t.dispose(),i(this,P).delete(e.arg1);return}},Kr=function(e){let t;if(this.options.initialDelayedAckBytes!==0){if(e.payload.length!==4)throw new Error("Invalid OKAY packet. Payload size should be 4");t=Vt(e.payload,0)}else{if(e.payload.length!==0)throw new Error("Invalid OKAY packet. Payload size should be 0");t=1/0}if(i(this,K).resolve(e.arg1,{remoteId:e.arg0,availableWriteBytes:t}))return;const r=i(this,P).get(e.arg1);if(r){r.ack(t);return}this.sendPacket(v.Close,e.arg1,e.arg0,be)},Qt=function(e,t,r){let n;return this.options.initialDelayedAckBytes!==0?(n=new Uint8Array(4),vs(n,0,r)):n=be,this.sendPacket(v.Okay,e,t,n)},jr=async function(e){const[t]=i(this,K).add();i(this,K).resolve(t,void 0);const r=e.arg0;let n=e.arg1,a=vt(e.payload);if(a.endsWith("\0")&&(a=a.substring(0,a.length-1)),this.options.initialDelayedAckBytes===0){if(n!==0)throw new Error("Invalid OPEN packet. arg1 should be 0");n=1/0}else if(n===0)throw new Error("Invalid OPEN packet. arg1 should be greater than 0");const o=i(this,ue).get(a);if(!o){await this.sendPacket(v.Close,0,r,be);return}const h=new vr({dispatcher:this,localId:t,remoteId:r,localCreated:!1,service:a,availableWriteBytes:n});try{await o(h.socket),i(this,P).set(t,h),await b(this,E,Qt).call(this,t,r,this.options.initialDelayedAckBytes)}catch{await this.sendPacket(v.Close,0,r,be)}},qr=async function(e){const t=i(this,P).get(e.arg1);if(!t)throw new Error(`Unknown local socket id: ${e.arg1}`);let r=!1;const n=[(async()=>{await t.enqueue(e.payload),await b(this,E,Qt).call(this,e.arg1,e.arg0,e.payload.length),r=!0})()];this.options.readTimeLimit&&n.push((async()=>{if(await ms(this.options.readTimeLimit),!r)throw new Error(`readable of \`${t.service}\` has stalled for ${this.options.readTimeLimit} milliseconds`)})()),await Promise.race(n)},Jt=function(){for(const e of i(this,P).values())e.dispose();i(this,xe).resolve()};const Nn=16777217,Er=[y.ShellV2,y.Cmd,y.StatV2,y.ListV2,y.FixedPushMkdir,"apex",y.Abb,"fixed_push_symlink_timestamp",y.AbbExec,"remount_shell","track_app",y.SendReceiveV2,"sendrecv_v2_brotli","sendrecv_v2_lz4","sendrecv_v2_zstd","sendrecv_v2_dry_run_send",y.DelayedAck],On=32*1024*1024;var ut,D,wt,ft,Te,yt;const cr=class cr{constructor({serial:e,connection:t,version:r,banner:n,features:a=Er,initialDelayedAckBytes:o,...h}){c(this,ut);c(this,D);c(this,wt);c(this,ft);c(this,Te);c(this,yt);if(l(this,wt,e),l(this,ut,t),l(this,Te,_t.parse(n)),l(this,yt,a),a.includes(y.DelayedAck)){if(o<=0)throw new TypeError("`initialDelayedAckBytes` must be greater than 0 when DelayedAck feature is enabled.");i(this,Te).features.includes(y.DelayedAck)||(o=0)}else o=0;let u,f;r>=Nn?(u=!1,f=!1):(u=!0,f=!0),l(this,D,new Ln(t,{calculateChecksum:u,appendNullToServiceString:f,initialDelayedAckBytes:o,...h})),l(this,ft,r)}static async authenticate({serial:e,connection:t,credentialStore:r,authenticators:n=Dn,features:a=Er,initialDelayedAckBytes:o=On,...h}){let u=16777217,f=1024*1024;const m=new k,A=new _n(n,r),F=new Ut,Z=t.readable.pipeTo(new Ft({async write(S){switch(S.command){case v.Connect:u=Math.min(u,S.arg0),f=Math.min(f,S.arg1),m.resolve(vt(S.payload));break;case v.Auth:{const es=await A.process(S);await lr(es);break}}}}),{preventCancel:!0,signal:F.signal}).then(()=>{m.reject(new Error("Connection closed unexpectedly"))},S=>{m.reject(S)}),X=t.writable.getWriter();async function lr(S){S.checksum=Br(S.payload),S.magic=S.command^4294967295,await De.WritableStream.write(X,S)}const Bt=a.slice();if(o<=0){const S=a.indexOf(y.DelayedAck);S!==-1&&Bt.splice(S,1)}let hr;try{await lr({command:v.Connect,arg0:u,arg1:f,payload:Y(`host::features=${Bt.join(",")}`)}),hr=await m.promise}finally{F.abort(),X.releaseLock(),await Z}return new cr({serial:e,connection:t,version:u,maxPayloadSize:f,banner:hr,features:Bt,initialDelayedAckBytes:o,...h})}get connection(){return i(this,ut)}get serial(){return i(this,wt)}get protocolVersion(){return i(this,ft)}get maxPayloadSize(){return i(this,D).options.maxPayloadSize}get banner(){return i(this,Te)}get disconnected(){return i(this,D).disconnected}get clientFeatures(){return i(this,yt)}connect(e){return i(this,D).createSocket(e)}addReverseTunnel(e,t){return t||(t=`localabstract:reverse_${Math.random().toString().substring(2)}`),i(this,D).addReverseTunnel(t,e),t}removeReverseTunnel(e){i(this,D).removeReverseTunnel(e)}clearReverseTunnels(){i(this,D).clearReverseTunnels()}close(){return i(this,D).close()}};ut=new WeakMap,D=new WeakMap,wt=new WeakMap,ft=new WeakMap,Te=new WeakMap,yt=new WeakMap;let Ar=cr;var Ce;class zn{constructor(e){c(this,Ce);l(this,Ce,e)}async check(){const e=await i(this,Ce).createConnection("host:mdns:check");try{return!(await e.readString()).startsWith("ERROR:")}finally{await e.dispose()}}async getServices(){const e=await i(this,Ce).createConnection("host:mdns:services");try{return(await e.readString()).split(`
`).filter(Boolean).map(r=>{const n=r.split("	");return{name:n[0],service:n[1],address:n[2]}})}finally{await e.dispose()}}}Ce=new WeakMap;const Fn=Y("OKAY"),Gr=Y("FAIL");var j,q,we;class kr{constructor(e){c(this,j);c(this,q);c(this,we);w(this,"readString",ws(function*(e){const t=yield*e(this.readExactly(4)),r=It(t);if(r===0)return"";{const n=new hs;let a="";const o=i(this,q).iterateExactly(r);for(;;){const{done:h,value:u}=o.next();if(h)break;a+=n.decode(yield*e(u),{stream:!0})}return a+=n.decode(),a}}));l(this,j,e),l(this,q,new ir(e.readable)),l(this,we,e.writable.getWriter())}readExactly(e){return i(this,q).readExactly(e)}async readOkay(){const e=await this.readExactly(4);if(!jt(e,Fn)){if(jt(e,Gr)){const t=await this.readString();throw new Error(t)}throw new Error(`Unexpected response: ${vt(e)}`)}}async writeString(e){const t=Y(e),r=new Uint8Array(4+t.length);Ss(r,0,t.length),r.set(t,4),await i(this,we).write(r)}release(){return i(this,we).releaseLock(),{readable:i(this,q).release(),writable:i(this,j).writable,closed:i(this,j).closed,close:()=>i(this,j).close()}}async dispose(){fs(i(this,q)),ys(i(this,we)),await i(this,j).close()}}j=new WeakMap,q=new WeakMap,we=new WeakMap;class Hr extends Error{constructor(e){super(e),this.name="NetworkError"}}class Yr extends Error{constructor(e){super(e),this.name="UnauthorizedError"}}class Zr extends Error{constructor(e){super(e),this.name="AlreadyConnectedError"}}var fe;class Un{constructor(e){c(this,fe);l(this,fe,e)}async pair(e,t){const r=await i(this,fe).createConnection(`host:pair:${t}:${e}`);try{const n=await r.readExactly(4);if(jt(n,Gr))throw new Error(await r.readString());const a=It(n);await r.readExactly(a)}finally{await r.dispose()}}async connect(e){const t=await i(this,fe).createConnection(`host:connect:${e}`);try{const r=await t.readString();switch(r){case`already connected to ${e}`:throw new Zr(r);case`failed to connect to ${e}`:case`failed to authenticate to ${e}`:throw new Yr(r);case`connected to ${e}`:return;default:throw new Hr(r)}}finally{await t.dispose()}}async disconnect(e){const t=await i(this,fe).createConnection(`host:disconnect:${e}`);try{await t.readString()}finally{await t.dispose()}}}fe=new WeakMap;function xr(s,e){e<0||e>=s.length||(s[e]=s[s.length-1],s.length-=1)}function kt(s,e){return s.filter(t=>e.includes(t.state))}var bt,O,_,L,er,Xr,Qr,Jr;class Vn{constructor(e){c(this,L);w(this,"current",[]);c(this,bt);c(this,O);c(this,_,[]);l(this,bt,e)}async createObserver(e){var F;(F=e==null?void 0:e.signal)==null||F.throwIfAborted();let t=[];const r=new ur,n=new ur,a=new wr,o=new wr,h=(e==null?void 0:e.includeStates)??["device","unauthorized"],u={includeStates:h,onDeviceAdd:r,onDeviceRemove:n,onListChange:a,onError:o};i(this,_).push(u),a.event(Z=>t=Z);let f;if(i(this,O))f=await i(this,O),a.fire(kt(this.current,h));else{l(this,O,b(this,L,Qr).call(this));try{f=await i(this,O)}catch(Z){throw l(this,O,void 0),Z}}const m=new zs(e),A=async()=>{xr(i(this,_),i(this,_).indexOf(u)),await b(this,L,Jr).call(this,f),m.unref()};if(e!=null&&e.signal){if(e.signal.aborted)throw await A(),e.signal.reason;e.signal.addEventListener("abort",()=>void A())}return{onDeviceAdd:r.event,onDeviceRemove:n.event,onListChange:a.event,onError:o.event,get current(){return t},stop:A}}}bt=new WeakMap,O=new WeakMap,_=new WeakMap,L=new WeakSet,er=async function(e){const t=await e.readString(),r=tr.parseDeviceList(t),n=this.current.slice(),a=[];for(const o of r){const h=n.findIndex(u=>u.transportId===o.transportId);if(h===-1){a.push(o);continue}xr(n,h)}if(this.current=r,a.length)for(const o of i(this,_)){const h=kt(a,o.includeStates);h.length&&o.onDeviceAdd.fire(h)}if(n.length)for(const o of i(this,_))kt(n,o.includeStates).length&&o.onDeviceRemove.fire(n);for(const o of i(this,_)){const h=kt(this.current,o.includeStates);o.onListChange.fire(h)}},Xr=async function(e){try{for(;;)await b(this,L,er).call(this,e)}catch(t){l(this,O,void 0);for(const r of i(this,_))r.onError.fire(t)}},Qr=async function(){const e=await i(this,bt).createConnection("host:track-devices-l",{unref:!0});return await b(this,L,er).call(this,e),b(this,L,Xr).call(this,e),e},Jr=async function(e){i(this,_).length===0&&(l(this,O,void 0),await e.dispose())};const Bn=[y.ShellV2,y.Cmd,y.StatV2,y.ListV2,y.FixedPushMkdir,"apex",y.Abb,"fixed_push_symlink_timestamp",y.AbbExec,"remount_shell","track_app",y.SendReceiveV2,"sendrecv_v2_brotli","sendrecv_v2_lz4","sendrecv_v2_zstd","sendrecv_v2_dry_run_send"];var G,Ie,pt,gt;class Wn{constructor(e,t,r,n,a){c(this,G);w(this,"serial");w(this,"transportId");w(this,"maxPayloadSize",1*1024*1024);w(this,"banner");c(this,Ie,[]);c(this,pt,new k);c(this,gt);l(this,G,e),this.serial=t,this.banner=r,this.transportId=n,l(this,gt,Promise.race([i(this,pt).promise,a]))}get disconnected(){return i(this,gt)}get clientFeatures(){return Bn}async connect(e){const t=await i(this,G).createDeviceConnection({transportId:this.transportId},e);return i(this,Ie).push(t),t}async addReverseTunnel(e,t){return await i(this,G).connector.addReverseTunnel(e,t)}async removeReverseTunnel(e){await i(this,G).connector.removeReverseTunnel(e)}async clearReverseTunnels(){await i(this,G).connector.clearReverseTunnels()}async close(){for(const e of i(this,Ie))await e.close();i(this,Ie).length=0,i(this,pt).resolve()}}G=new WeakMap,Ie=new WeakMap,pt=new WeakMap,gt=new WeakMap;var zt,mt,rr;const W=class W{constructor(e){c(this,mt);w(this,"connector");w(this,"wireless",new Un(this));w(this,"mDns",new zn(this));c(this,zt,new Vn(this));this.connector=e}static parseDeviceList(e,t=["device","unauthorized"]){const r=[];for(const n of e.split(`
`)){if(!n)continue;const a=n.split(" ").filter(Boolean),o=a[0],h=a[1];if(!t.includes(h))continue;let u,f,m,A;for(let F=2;F<a.length;F+=1){const[Z,X]=a[F].split(":");switch(Z){case"product":u=X;break;case"model":f=X;break;case"device":m=X;break;case"transport_id":A=BigInt(X);break}}if(!A)throw new Error(`No transport id for device ${o}`);r.push({serial:o,state:h,authenticating:h==="unauthorized",product:u,model:f,device:m,transportId:A})}return r}static formatDeviceService(e,t){if(!e)return`host:${t}`;if("transportId"in e)return`host-transport-id:${e.transportId}:${t}`;if("serial"in e)return`host-serial:${e.serial}:${t}`;if("usb"in e)return`host-usb:${t}`;if("tcp"in e)return`host-local:${t}`;throw new TypeError("Invalid device selector")}async createConnection(e,t){const r=await this.connector.connect(t),n=new kr(r);try{await n.writeString(e)}catch(a){throw await n.dispose(),a}try{return await $n(()=>n.readOkay(),t==null?void 0:t.signal),n}catch(a){throw await n.dispose(),a}}async getVersion(){const e=await this.createConnection("host:version");try{const t=It(await e.readExactly(4));return It(await e.readExactly(t))}finally{await e.dispose()}}async validateVersion(e){const t=await this.getVersion();if(t<e)throw new Error(`adb server version (${t}) doesn't match this client (${e})`)}async killServer(){await(await this.createConnection("host:kill")).dispose()}async getServerFeatures(){const e=await this.createConnection("host:host-features");try{return(await e.readString()).split(",")}finally{await e.dispose()}}async getDevices(e=["device","unauthorized"]){const t=await this.createConnection("host:devices-l");try{const r=await t.readString();return W.parseDeviceList(r,e)}finally{await t.dispose()}}async trackDevices(e){return i(this,zt).createObserver(e)}async reconnectDevice(e){const t=await this.createConnection(e==="offline"?"host:reconnect-offline":W.formatDeviceService(e,"reconnect"));try{await t.readString()}finally{await t.dispose()}}async getDeviceFeatures(e){const t=await this.createDeviceConnection(e,"host:features"),r=new kr(t);try{const a=(await r.readString()).split(",");return{transportId:t.transportId,features:a}}finally{await r.dispose()}}async createDeviceConnection(e,t){let r,n;if(!e)await this.validateVersion(41),r="host:tport:any";else if("transportId"in e)r=`host:transport-id:${e.transportId}`,n=e.transportId;else if("serial"in e)await this.validateVersion(41),r=`host:tport:serial:${e.serial}`;else if("usb"in e)await this.validateVersion(41),r="host:tport:usb";else if("tcp"in e)await this.validateVersion(41),r="host:tport:local";else throw new TypeError("Invalid device selector");const a=await this.createConnection(r);try{await a.writeString(t)}catch(o){throw await a.dispose(),o}try{if(n===void 0){const h=await a.readExactly(8);n=ds(h,0)}await a.readOkay();const o=a.release();return{transportId:n,service:t,readable:o.readable,writable:o.writable,get closed(){return o.closed},async close(){await o.close()}}}catch(o){throw await a.dispose(),o}}async waitFor(e,t,r){return t==="disconnect"&&await this.validateVersion(41),b(this,mt,rr).call(this,e,t,r)}async waitForDisconnect(e,t){if(await this.getVersion()>=41)return b(this,mt,rr).call(this,{transportId:e},"disconnect",t);{const n=await this.trackDevices(t);return new Promise((a,o)=>{n.onDeviceRemove(h=>{h.some(u=>u.transportId===e)&&(n.stop(),a())}),n.onError(h=>{n.stop(),o(h)})})}}async createTransport(e){const{transportId:t,features:r}=await this.getDeviceFeatures(e),a=(await this.getDevices()).find(m=>m.transportId===t),o=new _t(a==null?void 0:a.product,a==null?void 0:a.model,a==null?void 0:a.device,r),h=new Ut,u=this.waitForDisconnect(t,{unref:!0,signal:h.signal}),f=new Wn(this,(a==null?void 0:a.serial)??"",o,t,u);return f.disconnected.finally(()=>h.abort()),f}async createAdb(e){const t=await this.createTransport(e);return new yn(t)}};zt=new WeakMap,mt=new WeakSet,rr=async function(e,t,r){let n;if(!e)n="any";else if("transportId"in e)n="any";else if("serial"in e)n="any";else if("usb"in e)n="usb";else if("tcp"in e)n="local";else throw new TypeError("Invalid device selector");const a=W.formatDeviceService(e,`wait-for-${n}-${t}`),o=await this.createConnection(a,r);try{await o.readOkay()}finally{await o.dispose()}},w(W,"NetworkError",Hr),w(W,"UnauthorizedError",Yr),w(W,"AlreadyConnectedError",Zr);let tr=W;async function $n(s,...e){const t=new k;function r(){t.reject(this.reason)}try{for(const n of e)if(n){if(n.aborted)throw n.reason;n.addEventListener("abort",r)}return await Promise.race([s(),t.promise])}finally{for(const n of e)n&&n.removeEventListener("abort",r)}}export{Er as ADB_DAEMON_DEFAULT_FEATURES,On as ADB_DAEMON_DEFAULT_INITIAL_PAYLOAD_SIZE,Nn as ADB_DAEMON_VERSION_OMIT_CHECKSUM,Dn as ADB_DEFAULT_AUTHENTICATORS,Bn as ADB_SERVER_DEFAULT_FEATURES,zr as ADB_SYNC_MAX_PACKET_SIZE,xn as ASN1_NULL,kn as ASN1_OCTET_STRING,Tn as ASN1_OID,Sr as ASN1_SEQUENCE,yn as Adb,Rt as AdbAuthType,_n as AdbAuthenticationProcessor,_t as AdbBanner,At as AdbBannerKey,v as AdbCommand,Rn as AdbDaemonSocket,vr as AdbDaemonSocketController,Ar as AdbDaemonTransport,y as AdbFeature,Ir as AdbFrameBufferError,Ps as AdbFrameBufferForbiddenError,Is as AdbFrameBufferUnsupportedVersionError,Ts as AdbFrameBufferV1,Cs as AdbFrameBufferV2,Fs as AdbNoneProtocolProcessImpl,Us as AdbNoneProtocolPtyProcess,Vs as AdbNoneProtocolSpawner,Bs as AdbNoneProtocolSubprocessService,ei as AdbPacket,Ln as AdbPacketDispatcher,Xt as AdbPacketHeader,ti as AdbPacketSerializeStream,_s as AdbPower,Pn as AdbPublicKeyAuthenticator,ni as AdbReverseError,ii as AdbReverseNotSupportedError,gs as AdbReverseService,tr as AdbServerClient,Vn as AdbServerDeviceObserverOwner,kr as AdbServerStream,Wn as AdbServerTransport,Cr as AdbServiceBase,H as AdbShellProtocolId,Pe as AdbShellProtocolPacket,Ws as AdbShellProtocolProcessImpl,$s as AdbShellProtocolPtyProcess,Ms as AdbShellProtocolSpawner,Ks as AdbShellProtocolSubprocessService,In as AdbSignatureAuthenticator,js as AdbSubprocessService,wn as AdbSync,yr as AdbSyncDataResponse,Qs as AdbSyncEntry2Response,Xs as AdbSyncEntryResponse,Gs as AdbSyncError,Rr as AdbSyncFailResponse,Nr as AdbSyncLstatResponse,fr as AdbSyncNumberRequest,nn as AdbSyncOkResponse,R as AdbSyncRequestId,C as AdbSyncResponseId,br as AdbSyncSendV2Flags,on as AdbSyncSendV2Request,dn as AdbSyncSocket,hn as AdbSyncSocketLocked,Or as AdbSyncStatErrorCode,ar as AdbSyncStatResponse,fn as AdbTcpIpService,Pr as AutoResetEvent,Gr as FAIL,Lr as LinuxFileType,ps as NOOP,zs as Ref,Mt as SHA1_DIGEST_INFO,mr as SHA1_DIGEST_LENGTH,En as adbGeneratePublicKey,Vr as adbGetPublicKeySize,p as adbSyncEncodeId,Ys as adbSyncLstat,tn as adbSyncOpenDir,en as adbSyncOpenDirV1,Js as adbSyncOpenDirV2,sn as adbSyncPull,rn as adbSyncPullGenerator,ln as adbSyncPush,an as adbSyncPushV1,cn as adbSyncPushV2,Pt as adbSyncReadResponse,Dt as adbSyncReadResponses,Zs as adbSyncStat,z as adbSyncWriteRequest,Dr as calculateBase64EncodedLength,Br as calculateChecksum,Jn as decodeBase64,vt as decodeUtf8,un as dirname,Rs as encodeBase64,Y as encodeUtf8,qt as escapeArg,Ds as framebuffer,Yt as getBigUint,It as hexToNumber,Sn as modInverse,An as powMod,$n as raceSignal,Ur as rsaParsePrivateKey,Cn as rsaSign,jt as sequenceEqual,Zt as setBigUint,_r as splitCommand,Qn as toLocalUint8Array,xr as unorderedRemove,bs as unreachable,Ss as write4HexDigits};

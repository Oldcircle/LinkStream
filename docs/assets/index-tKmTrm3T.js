var ir=Object.defineProperty;var l=a=>{throw TypeError(a)};var yr=(a,s,e)=>s in a?ir(a,s,{enumerable:!0,configurable:!0,writable:!0,value:e}):a[s]=e;var t=(a,s,e)=>yr(a,typeof s!="symbol"?s+"":s,e),G=(a,s,e)=>s.has(a)||l("Cannot "+e);var c=(a,s,e)=>(G(a,s,"read from private field"),e?e.call(a):s.get(a)),h=(a,s,e)=>s.has(a)?l("Cannot add the same private member more than once"):s instanceof WeakSet?s.add(a):s.set(a,e),d=(a,s,e,r)=>(G(a,s,"write to private field"),r?r.call(a,e):s.set(a,e),e),v=(a,s,e)=>(G(a,s,"access private method"),e);import{D as vr,S as gr,a as pr,b as Sr,c as fr,d as mr,e as _r,f as br,g as Cr,h as Er,i as xr,j as Ar,k as Dr,l as Rr,t as O,m as kr,n as Pr,o as Nr,p as Tr,q as Br,r as Mr,s as qr,u as zr,v as Hr,w as Wr,x as Fr,y as Vr,z as $r,A as Ir,B as rr,C as Lr}from"./3_3_2-DmD8R-J5.js";import{I as Ur,S as jr}from"./split-string-NR4_hcTk.js";import{S as V,h as Kr,a as Xr,A as Yr}from"./h265-BZeEvzU-.js";import{S as Gr}from"./sticky-event-emitter-B3ySTSV4.js";import{d as Jr,c as er,N as Qr}from"./reverse-D3S_M3ap.js";import{T as Zr}from"./encoding-D3q_jWej.js";import{A as lr,W as Or}from"./stream-BT4ImN5b.js";import{B as sr,P as J,e as re,t as ee}from"./struct-deserialize-bkGssrR1.js";import"./string-Gn2dS4oc.js";import"./uint32-BfumdTHg.js";const se="scrcpy";class ar{constructor(s,e){t(this,"adb");t(this,"options");t(this,"socketName");this.adb=s,this.options=e,this.socketName=this.getSocketName()}initialize(){}getSocketName(){let s="localabstract:"+se;return this.options.scid!==void 0&&(s+="_"+this.options.scid.padStart(8,"0")),s}dispose(){}}var P,S,tr,$;class L extends ar{constructor(){super(...arguments);h(this,S);h(this,P,!1)}async getStreams(){let{sendDummyByte:e}=this.options;const r={};if(this.options.video){const u=await v(this,S,$).call(this,e);r.video=u.readable,e=!1}if(this.options.audio){const u=await v(this,S,$).call(this,e);r.audio=u.readable,e=!1}if(this.options.control){const u=await v(this,S,$).call(this,e);r.control=u,e=!1}return r}dispose(){d(this,P,!0)}}P=new WeakMap,S=new WeakSet,tr=function(){return this.adb.createSocket(this.socketName)},$=async function(e){for(let r=0;!c(this,P)&&r<100;r+=1)try{const u=await v(this,S,tr).call(this);if(e){const n=new sr(u.readable);return await n.readExactly(1),{readable:n.release(),writable:u.writable}}return u}catch{await Jr(100)}throw new Error("Can't connect to server after 100 retries")};var N,T,D,I;class U extends ar{constructor(){super(...arguments);h(this,D);h(this,N);h(this,T)}async initialize(){await this.adb.reverse.remove(this.socketName).catch(u=>{if(u instanceof er)throw u});let e;const r=new J(u=>{e=u});d(this,N,r.getReader()),d(this,T,await this.adb.reverse.add(this.socketName,async u=>{await e.enqueue(u)}))}async getStreams(){const e={};if(this.options.video){const r=await v(this,D,I).call(this);e.video=r.readable}if(this.options.audio){const r=await v(this,D,I).call(this);e.audio=r.readable}if(this.options.control){const r=await v(this,D,I).call(this);e.control=r}return e}dispose(){this.adb.reverse.remove(c(this,T)).catch(Qr)}}N=new WeakMap,T=new WeakMap,D=new WeakSet,I=async function(){return(await c(this,N).read()).value};function _(a,s){const e={scid:void 0,video:!0,audio:!1,control:!0,sendDummyByte:!0};return s.tunnelForward?new L(a,e):new U(a,e)}var B,M,q,C,E,x,f,ur,or,cr;class ae{constructor(s,e,r){h(this,f);h(this,B);h(this,M);h(this,q);h(this,C,new Gr);h(this,E,0);h(this,x,0);d(this,B,s),d(this,M,e),d(this,q,r.pipeThrough(c(this,B).createMediaStreamTransformer()).pipeThrough(new Ur(u=>{if(u.type==="configuration")switch(e.codec){case V.H264:v(this,f,ur).call(this,u.data);break;case V.H265:v(this,f,or).call(this,u.data);break;case V.AV1:break}else e.codec===V.AV1&&v(this,f,cr).call(this,u.data)})))}get metadata(){return c(this,M)}get stream(){return c(this,q)}get sizeChanged(){return c(this,C).event}get width(){return c(this,E)}get height(){return c(this,x)}}B=new WeakMap,M=new WeakMap,q=new WeakMap,C=new WeakMap,E=new WeakMap,x=new WeakMap,f=new WeakSet,ur=function(s){const{croppedWidth:e,croppedHeight:r}=Kr(s);d(this,E,e),d(this,x,r),c(this,C).fire({width:e,height:r})},or=function(s){const{croppedWidth:e,croppedHeight:r}=Xr(s);d(this,E,e),d(this,x,r),c(this,C).fire({width:e,height:r})},cr=function(s){const r=new Yr(s).searchSequenceHeaderObu();if(!r)return;const{max_frame_width_minus_1:u,max_frame_height_minus_1:n}=r,w=u+1,p=n+1;d(this,E,w),d(this,x,p),c(this,C).fire({width:w,height:p})};function te(a){return new J(async s=>{for(const e of a)await s.enqueue(e)})}function ue(...a){return new J(async s=>{for(const e of a){const r=e.getReader();for(;;){const{done:u,value:n}=await r.read();if(u)break;await s.enqueue(n)}}})}class Q extends Error{constructor(e){super("scrcpy server exited prematurely");t(this,"output");this.output=e}}var g,R,z,H,W,F,m,nr,hr,dr;const Z=class Z{constructor({options:s,process:e,output:r,videoStream:u,audioStream:n,controlStream:w}){h(this,m);h(this,g);h(this,R);h(this,z);h(this,H);h(this,W);h(this,F);d(this,g,s),d(this,R,e),d(this,z,r),d(this,H,u?v(this,m,hr).call(this,u):void 0),d(this,W,n?v(this,m,dr).call(this,n):void 0),w&&(d(this,F,new gr(w.writable.getWriter(),s)),v(this,m,nr).call(this,w.readable).catch(()=>{}))}static async pushServer(s,e,r=vr){const u=await s.sync();try{await u.write({filename:r,file:e})}finally{await u.dispose()}}static async start(s,e,r){let u,n;try{try{u=r.createConnection(s),await u.initialize()}catch(A){if(A instanceof er)r.value.tunnelForward=!0,u=r.createConnection(s),await u.initialize();else throw u=void 0,A}const w=["app_process","-cp",e,"/","com.genymobile.scrcpy.Server",r.version,...r.serialize()];r.spawner?n=await r.spawner.spawn(w):n=await s.subprocess.noneProtocol.spawn(w);const p=n.output.pipeThrough(new Zr).pipeThrough(new jr(`
`)),K=[],X=new lr,wr=p.pipeTo(new Or({write(A){K.push(A)}}),{signal:X.signal,preventCancel:!0}).catch(A=>{if(!X.signal.aborted)throw A}),Y=await Promise.race([n.exited.then(()=>{throw new Q(K)}),u.getStreams()]);return X.abort(),await wr,new Z({options:r,process:n,output:ue(te(K),p),videoStream:Y.video,audioStream:Y.audio,controlStream:Y.control})}catch(w){throw await(n==null?void 0:n.kill()),w}finally{u==null||u.dispose()}}static getEncoders(s,e,r){return r.setListEncoders(),r.getEncoders(s,e)}static getDisplays(s,e,r){return r.setListDisplays(),r.getDisplays(s,e)}get output(){return c(this,z)}get exited(){return c(this,R).exited}get videoStream(){return c(this,H)}get audioStream(){return c(this,W)}get controller(){return c(this,F)}get clipboard(){return c(this,g).clipboard}async close(){await c(this,R).kill()}};g=new WeakMap,R=new WeakMap,z=new WeakMap,H=new WeakMap,W=new WeakMap,F=new WeakMap,m=new WeakSet,nr=async function(s){const e=new sr(s);try{for(;;){let r;try{r=(await e.readExactly(1))[0]}catch(u){if(u instanceof re){c(this,g).deviceMessageParsers.close();break}throw u}await c(this,g).deviceMessageParsers.parse(r,e)}}catch(r){c(this,g).deviceMessageParsers.error(r),await ee(e)}},hr=async function(s){const{metadata:e,stream:r}=await c(this,g).parseVideoStreamMetadata(s);return new ae(c(this,g),e,r)},dr=async function(s){if(!c(this,g).parseAudioStreamMetadata)throw new Error("parsing audio stream is not supported in this version");const e=await c(this,g).parseAudioStreamMetadata(s);switch(e.type){case"disabled":case"errored":return e;case"success":return{...e,stream:e.stream.pipeThrough(c(this,g).createMediaStreamTransformer())};default:throw new Error(`Unexpected audio metadata type ${e.type}`)}};let k=Z;async function o(a,s,e){var r;try{throw await(await k.start(a,s,e)).close(),new Error("Unexpected server output")}catch(u){if(u instanceof Q){if((r=u.output[0])!=null&&r.startsWith("[server] ERROR:"))throw u;const n=[];for(const w of u.output){const p=e.parseDisplay(w);p&&n.push(p)}return n}throw u}}class me extends pr{constructor(e,r){super(e);t(this,"version");t(this,"spawner");this.version=(r==null?void 0:r.version)??"1.15",this.spawner=r==null?void 0:r.spawner}getDisplays(e,r){return o(e,r,this)}createConnection(e){return _(e,this.value)}}class _e extends Sr{constructor(e,r){super(e);t(this,"version");t(this,"spawner");this.version=(r==null?void 0:r.version)??"1.15.1",this.spawner=r==null?void 0:r.spawner}getDisplays(e,r){return o(e,r,this)}createConnection(e){return _(e,this.value)}}class be extends fr{constructor(e,r){super(e);t(this,"version");t(this,"spawner");this.version=(r==null?void 0:r.version)??"1.16",this.spawner=r==null?void 0:r.spawner}getDisplays(e,r){return o(e,r,this)}createConnection(e){return _(e,this.value)}}async function b(a,s,e){const r=await k.start(a,s,e),u=[];for await(const n of r.output){const w=e.parseEncoder(n);w&&u.push(w)}return u}class Ce extends mr{constructor(e,r){super(e);t(this,"version");t(this,"spawner");this.version=(r==null?void 0:r.version)??"1.17",this.spawner=r==null?void 0:r.spawner}getDisplays(e,r){return o(e,r,this)}createConnection(e){return _(e,this.value)}}class Ee extends _r{constructor(e,r){super(e);t(this,"version");t(this,"spawner");this.version=(r==null?void 0:r.version)??"1.18",this.spawner=r==null?void 0:r.spawner}getEncoders(e,r){return b(e,r,this)}getDisplays(e,r){return o(e,r,this)}createConnection(e){return _(e,this.value)}}class xe extends br{constructor(e,r){super(e);t(this,"version");t(this,"spawner");this.version=(r==null?void 0:r.version)??"1.19",this.spawner=r==null?void 0:r.spawner}getEncoders(e,r){return b(e,r,this)}getDisplays(e,r){return o(e,r,this)}createConnection(e){return _(e,this.value)}}class Ae extends Cr{constructor(e,r){super(e);t(this,"version");t(this,"spawner");this.version=(r==null?void 0:r.version)??"1.20",this.spawner=r==null?void 0:r.spawner}getEncoders(e,r){return b(e,r,this)}getDisplays(e,r){return o(e,r,this)}createConnection(e){return _(e,this.value)}}class De extends Er{constructor(e,r){super(e);t(this,"version");t(this,"spawner");this.version=(r==null?void 0:r.version)??"1.21",this.spawner=r==null?void 0:r.spawner}getEncoders(e,r){return b(e,r,this)}getDisplays(e,r){return o(e,r,this)}createConnection(e){return _(e,this.value)}}function j(a,s){const e={scid:void 0,video:!0,audio:!1,control:s.control,sendDummyByte:s.sendDummyByte};return s.tunnelForward?new L(a,e):new U(a,e)}class Re extends xr{constructor(e,r){super(e);t(this,"version");t(this,"spawner");this.version=(r==null?void 0:r.version)??"1.22",this.spawner=r==null?void 0:r.spawner}getEncoders(e,r){return b(e,r,this)}getDisplays(e,r){return o(e,r,this)}createConnection(e){return j(e,this.value)}}class ke extends Ar{constructor(e,r){super(e);t(this,"version");t(this,"spawner");this.version=(r==null?void 0:r.version)??"1.23",this.spawner=r==null?void 0:r.spawner}getEncoders(e,r){return b(e,r,this)}getDisplays(e,r){return o(e,r,this)}createConnection(e){return j(e,this.value)}}class Pe extends Dr{constructor(e,r){super(e);t(this,"version");t(this,"spawner");this.version=(r==null?void 0:r.version)??"1.24",this.spawner=r==null?void 0:r.spawner}getEncoders(e,r){return b(e,r,this)}getDisplays(e,r){return o(e,r,this)}createConnection(e){return j(e,this.value)}}class Ne extends Rr{constructor(e,r){super(e);t(this,"version");t(this,"spawner");this.version=(r==null?void 0:r.version)??"1.25",this.spawner=r==null?void 0:r.spawner}getEncoders(e,r){return b(e,r,this)}getDisplays(e,r){return o(e,r,this)}createConnection(e){return j(e,this.value)}}function oe(a,s){const e={scid:O(s.scid,void 0),video:!0,audio:s.audio,control:s.control,sendDummyByte:s.sendDummyByte};return s.tunnelForward?new L(a,e):new U(a,e)}async function i(a,s,e){var r;try{throw await(await k.start(a,s,e)).close(),new Error("Unexpected server output")}catch(u){if(u instanceof Q){if((r=u.output[0])!=null&&r.startsWith("[server] ERROR:"))throw u;const n=[];for(const w of u.output){const p=e.parseEncoder(w);p&&n.push(p)}return n}throw u}}class Te extends kr{constructor(e,r){super(e);t(this,"version");t(this,"spawner");this.version=(r==null?void 0:r.version)??"2.0",this.spawner=r==null?void 0:r.spawner}getEncoders(e,r){return i(e,r,this)}getDisplays(e,r){return o(e,r,this)}createConnection(e){return oe(e,this.value)}}function y(a,s){const e={scid:O(s.scid,void 0),video:s.video,audio:s.audio,control:s.control,sendDummyByte:s.sendDummyByte};return s.tunnelForward?new L(a,e):new U(a,e)}class Be extends Pr{constructor(e,r){super(e);t(this,"version");t(this,"spawner");this.version=(r==null?void 0:r.version)??"2.1",this.spawner=r==null?void 0:r.spawner}getEncoders(e,r){return i(e,r,this)}getDisplays(e,r){return o(e,r,this)}createConnection(e){return y(e,this.value)}}class Me extends Nr{constructor(e,r){super(e);t(this,"version");t(this,"spawner");this.version=(r==null?void 0:r.version)??"v2.2",this.spawner=r==null?void 0:r.spawner}getEncoders(e,r){return i(e,r,this)}getDisplays(e,r){return o(e,r,this)}createConnection(e){return y(e,this.value)}}class qe extends Tr{constructor(e,r){super(e);t(this,"version");t(this,"spawner");this.version=(r==null?void 0:r.version)??"2.3",this.spawner=r==null?void 0:r.spawner}getEncoders(e,r){return i(e,r,this)}getDisplays(e,r){return o(e,r,this)}createConnection(e){return y(e,this.value)}}class ze extends Br{constructor(e,r){super(e);t(this,"version");t(this,"spawner");this.version=(r==null?void 0:r.version)??"2.4",this.spawner=r==null?void 0:r.spawner}getEncoders(e,r){return i(e,r,this)}getDisplays(e,r){return o(e,r,this)}createConnection(e){return y(e,this.value)}}class He extends Mr{constructor(e,r){super(e);t(this,"version");t(this,"spawner");this.version=(r==null?void 0:r.version)??"2.5",this.spawner=r==null?void 0:r.spawner}getEncoders(e,r){return i(e,r,this)}getDisplays(e,r){return o(e,r,this)}createConnection(e){return y(e,this.value)}}class We extends qr{constructor(e,r){super(e);t(this,"version");t(this,"spawner");this.version=(r==null?void 0:r.version)??"2.6",this.spawner=r==null?void 0:r.spawner}getEncoders(e,r){return i(e,r,this)}getDisplays(e,r){return o(e,r,this)}createConnection(e){return y(e,this.value)}}class Fe extends zr{constructor(e,r){super(e);t(this,"version");t(this,"spawner");this.version=(r==null?void 0:r.version)??"2.7",this.spawner=r==null?void 0:r.spawner}getEncoders(e,r){return i(e,r,this)}getDisplays(e,r){return o(e,r,this)}createConnection(e){return y(e,this.value)}}class Ve extends Hr{constructor(e,r){super(e);t(this,"version");t(this,"spawner");this.version=(r==null?void 0:r.version)??"3.0",this.spawner=r==null?void 0:r.spawner}getEncoders(e,r){return i(e,r,this)}getDisplays(e,r){return o(e,r,this)}createConnection(e){return y(e,this.value)}}class $e extends Wr{constructor(e,r){super(e);t(this,"version");t(this,"spawner");this.version=(r==null?void 0:r.version)??"3.0.1",this.spawner=r==null?void 0:r.spawner}getEncoders(e,r){return i(e,r,this)}getDisplays(e,r){return o(e,r,this)}createConnection(e){return y(e,this.value)}}class Ie extends Fr{constructor(e,r){super(e);t(this,"version");t(this,"spawner");this.version=(r==null?void 0:r.version)??"3.0.2",this.spawner=r==null?void 0:r.spawner}getEncoders(e,r){return i(e,r,this)}getDisplays(e,r){return o(e,r,this)}createConnection(e){return y(e,this.value)}}class Le extends Vr{constructor(e,r){super(e);t(this,"version");t(this,"spawner");this.version=(r==null?void 0:r.version)??"3.1",this.spawner=r==null?void 0:r.spawner}getEncoders(e,r){return i(e,r,this)}getDisplays(e,r){return o(e,r,this)}createConnection(e){return y(e,this.value)}}class Ue extends $r{constructor(e,r){super(e);t(this,"version");t(this,"spawner");this.version=(r==null?void 0:r.version)??"3.2",this.spawner=r==null?void 0:r.spawner}getEncoders(e,r){return i(e,r,this)}getDisplays(e,r){return o(e,r,this)}createConnection(e){return y(e,this.value)}}class je extends Ir{constructor(e,r){super(e);t(this,"version");t(this,"spawner");this.version=(r==null?void 0:r.version)??"3.3",this.spawner=r==null?void 0:r.spawner}getEncoders(e,r){return i(e,r,this)}getDisplays(e,r){return o(e,r,this)}createConnection(e){return y(e,this.value)}}class Ke extends rr{constructor(e,r){super(e);t(this,"version");t(this,"spawner");this.version=(r==null?void 0:r.version)??"3.3.1",this.spawner=r==null?void 0:r.spawner}getEncoders(e,r){return i(e,r,this)}getDisplays(e,r){return o(e,r,this)}createConnection(e){return y(e,this.value)}}class Xe extends Lr{constructor(e,r){super(e);t(this,"version");t(this,"spawner");this.version=(r==null?void 0:r.version)??"3.3.2",this.spawner=r==null?void 0:r.spawner}getEncoders(e,r){return i(e,r,this)}getDisplays(e,r){return o(e,r,this)}createConnection(e){return y(e,this.value)}}class ce extends rr{constructor(e,r){super(e);t(this,"version");t(this,"spawner");this.version=(r==null?void 0:r.version)??"3.3.3",this.spawner=r==null?void 0:r.spawner}getEncoders(e,r){return i(e,r,this)}getDisplays(e,r){return o(e,r,this)}createConnection(e){return y(e,this.value)}}class Ye extends ce{constructor(s,e){super(s,e)}}export{k as AdbScrcpyClient,ar as AdbScrcpyConnection,Q as AdbScrcpyExitedError,L as AdbScrcpyForwardConnection,me as AdbScrcpyOptions1_15,_e as AdbScrcpyOptions1_15_1,be as AdbScrcpyOptions1_16,Ce as AdbScrcpyOptions1_17,Ee as AdbScrcpyOptions1_18,xe as AdbScrcpyOptions1_19,Ae as AdbScrcpyOptions1_20,De as AdbScrcpyOptions1_21,Re as AdbScrcpyOptions1_22,ke as AdbScrcpyOptions1_23,Pe as AdbScrcpyOptions1_24,Ne as AdbScrcpyOptions1_25,Te as AdbScrcpyOptions2_0,Be as AdbScrcpyOptions2_1,Me as AdbScrcpyOptions2_2,qe as AdbScrcpyOptions2_3,ze as AdbScrcpyOptions2_4,He as AdbScrcpyOptions2_5,We as AdbScrcpyOptions2_6,Fe as AdbScrcpyOptions2_7,Ve as AdbScrcpyOptions3_0,$e as AdbScrcpyOptions3_0_1,Ie as AdbScrcpyOptions3_0_2,Le as AdbScrcpyOptions3_1,Ue as AdbScrcpyOptions3_2,je as AdbScrcpyOptions3_3,Ke as AdbScrcpyOptions3_3_1,Xe as AdbScrcpyOptions3_3_2,ce as AdbScrcpyOptions3_3_3,Ye as AdbScrcpyOptionsLatest,U as AdbScrcpyReverseConnection,se as SCRCPY_SOCKET_NAME_PREFIX};

const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-V_WUKhLh.js","assets/stream-BT4ImN5b.js","assets/distribution-vvPj2d0I.js","assets/struct-deserialize-bkGssrR1.js","assets/encoding-D3q_jWej.js","assets/string-Gn2dS4oc.js","assets/uint32-BfumdTHg.js","assets/reverse-D3S_M3ap.js","assets/sticky-event-emitter-B3ySTSV4.js","assets/index-tKmTrm3T.js","assets/3_3_2-DmD8R-J5.js","assets/h265-BZeEvzU-.js","assets/split-string-NR4_hcTk.js","assets/index-CrHIl016.js","assets/index-BIY0HUUT.js","assets/index--RZXy6Ug.js","assets/index-Di93NhIW.js"])))=>i.map(i=>d[i]);
import{_ as u}from"./index--RZXy6Ug.js";async function P(s,t){var l,S,g,_,B,A,U,E;let o=null;try{t("Requesting Android device via WebUSB...","info");try{const i=window.isSecureContext,c=navigator.userAgent;t(`Env: secure=${i} ua=${c}`,"info");const p=await((S=(l=navigator.usb).getDevices)==null?void 0:S.call(l));p&&t(`Known USB devices: ${p.length}`,"info")}catch{}const e=await u(()=>import("./index-CwCV73Rw.js"),[]),d=await u(()=>import("./index-V_WUKhLh.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8])),f=await u(()=>import("./index-tKmTrm3T.js"),__vite__mapDeps([9,10,3,1,5,6,11,12,8,7,4])),I=await u(()=>import("./index-CrHIl016.js"),__vite__mapDeps([13,10,3,1,5,6,11])),N=await u(()=>import("./index-BIY0HUUT.js"),__vite__mapDeps([14,11,6,8,1,15])),b=await u(()=>import("./index-Di93NhIW.js"),__vite__mapDeps([16,3,1,2,4,12]));if(!navigator.usb)throw new Error("WebUSB not available: use Chrome/Edge over HTTPS or localhost");const D=[{vendorId:6353},{vendorId:1256},{vendorId:4817},{vendorId:10007},{vendorId:10864},{vendorId:8921},{vendorId:11669}];let a;try{typeof((g=e.AdbWebUsbBackend)==null?void 0:g.requestDevice)=="function"?a=await e.AdbWebUsbBackend.requestDevice({filters:D}):a=await navigator.usb.requestDevice({filters:D})}catch(i){if((i==null?void 0:i.name)==="NotFoundError")t("No matching Android device found with filters, showing all devices...","info"),typeof((_=e.AdbWebUsbBackend)==null?void 0:_.requestDevice)=="function"?a=await e.AdbWebUsbBackend.requestDevice({filters:[]}):a=await navigator.usb.requestDevice({filters:[]});else throw i}if(!a)throw new Error("No device selected");const r=(a==null?void 0:a.device)??a;try{const i={vendorId:r==null?void 0:r.vendorId,productId:r==null?void 0:r.productId,productName:r==null?void 0:r.productName,manufacturerName:r==null?void 0:r.manufacturerName,serialNumber:r==null?void 0:r.serialNumber};t(`Selected device: ${JSON.stringify(i)}`,"info")}catch{}try{if(typeof r.open=="function"&&!r.opened&&await r.open(),typeof r.selectConfiguration=="function"&&r.configuration==null)try{await r.selectConfiguration(1)}catch{}}catch{}let y;if(typeof((B=e.AdbWebUsbBackend)==null?void 0:B.fromDevice)=="function")y=await e.AdbWebUsbBackend.fromDevice(r);else if(typeof e.AdbWebUsbBackend=="function")y=new e.AdbWebUsbBackend(r);else throw new Error("AdbWebUsbBackend not available");let v;try{v=await y.connect()}catch(i){const c=String((i==null?void 0:i.message)||"");throw c.includes("claimInterface")&&t("Unable to claim USB ADB interface. On Windows, install WinUSB driver for the ADB interface (use Zadig or Google USB Driver), close OEM phone suites (HiSuite/Kies), replug the device, and ensure USB debugging is enabled.","error"),c.includes("addEventListener")&&t("WebUSB backend initialization failed (addEventListener on undefined). Ensure latest Chrome/Edge is used and the backend received a USBDevice (not a wrapper). Replug the device and retry.","error"),i}const w=new d.Adb(v);typeof w.connect=="function"&&await w.connect(),t("Starting scrcpy server on device...","info");const k=f.AdbScrcpyOptions2_1??f.AdbScrcpyOptions1_24,W=new k({video:{codec:"h264",maxSize:1080,bitRate:8e6,tunnel:"adb"},audio:!1,tunnelForward:!0});try{t(`scrcpy options: ${JSON.stringify({codec:"h264",maxSize:1080,bitRate:8e6,audio:!1,tunnel:"adb",tunnelForward:!0})}`,"info")}catch{}let n;try{n=await f.AdbScrcpyClient.start(w,I.DefaultServerPath,W)}catch{const c=new f.AdbScrcpyClient(w,W);try{n={streams:await c.start()}}catch(p){throw t("ADB unauthorized or scrcpy server failed to start. Please accept USB debugging dialog on device and try again.","error"),p}}if((A=n==null?void 0:n.output)!=null&&A.pipeTo&&(b!=null&&b.WritableStream))try{await n.output.pipeTo(new b.WritableStream({write(i){const c=typeof i=="string"?i:(()=>{try{return new TextDecoder().decode(i)}catch{return String(i)}})();t(`scrcpy: ${c}`,"info")}}))}catch{}const m=new N.ScrcpyDecoderWebCodecs({canvas:s}),h=n.videoStream??((U=n.streams)==null?void 0:U.video)??n.streams??n;if(!h)throw new Error("No video stream from scrcpy");t("Decoding H.264 stream via WebCodecs...","info"),typeof m.decode=="function"?m.decode(h):typeof m.render=="function"&&m.render(h),o=async()=>{try{typeof n.close=="function"&&await n.close(),typeof v.close=="function"&&await v.close()}catch{}},t("USB mirror started","success")}catch(e){console.error(e);let d="";(e==null?void 0:e.name)==="SecurityError"&&(d="SecurityError: use HTTPS (GitHub Pages) or localhost, and enable USB debugging."),(e==null?void 0:e.name)==="NotFoundError"&&(d="No device selected or no matching device; ensure phone is connected and unlocked."),(E=e==null?void 0:e.message)!=null&&E.includes("unauthorized")&&(d="Device unauthorized: accept the USB debugging prompt and check Developer options.");const f=JSON.stringify({name:e==null?void 0:e.name,message:e==null?void 0:e.message,stack:e==null?void 0:e.stack},null,2);throw t(`USB mirror failed: ${(e==null?void 0:e.message)||e}${d?" | "+d:""}
${f}`,"error"),e}return{stop:async()=>{o&&await o(),t("USB mirror stopped","info")}}}async function T(s){try{s("Resetting ADB/WebUSB state...","info");const t=navigator.usb;if(t&&typeof t.getDevices=="function"){const o=await t.getDevices();s(`Known USB devices: ${(o==null?void 0:o.length)??0}`,"info");for(const l of o)try{l.opened&&await l.close()}catch{}s("Closed any opened WebUSB device handles.","info")}s('If PC adb.exe is running, run "adb kill-server" to free ADB.',"info")}catch(t){s(`ADB reset failed: ${(t==null?void 0:t.message)||t}`,"error")}}export{T as resetAdb,P as startUsbMirror};
